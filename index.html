<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Printer | Professional Print Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 950: '#0b0f19', 900: '#111827', 800: '#1f2937', 600: '#2563eb', 500: '#3b82f6', 400: '#60a5fa' },
                        kyocera: { red: '#c41230' }
                    }
                }
            }
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0b0f19; color: white; }
        
        /* Realistic Paper Shadow */
        .paper-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.2); }
        
        /* Visual Finishing Marks */
        .staple-mark { position: absolute; width: 30px; height: 6px; background: linear-gradient(90deg, #94a3b8, #e2e8f0, #94a3b8); border-radius: 2px; box-shadow: 1px 1px 2px rgba(0,0,0,0.5); z-index: 20; }
        .punch-hole { width: 14px; height: 14px; background: #111827; border-radius: 50%; box-shadow: inset 1px 1px 3px rgba(0,0,0,0.8); z-index: 20; }
        .fold-line { position: absolute; border-left: 1px dashed rgba(0,0,0,0.3); height: 100%; z-index: 10; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-100">

    <nav class="w-20 lg:w-64 bg-brand-900 border-r border-gray-800 flex flex-col justify-between hidden md:flex z-20">
        <div>
            <div class="p-6 flex items-center gap-3">
                <div class="w-10 h-10 bg-brand-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-900/20">
                    <i class="fa-solid fa-layer-group text-white"></i>
                </div>
                <div class="hidden lg:block">
                    <h1 class="font-bold text-lg leading-tight">MAGIC<span class="text-brand-400">PRINTER</span></h1>
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest">Business Hub</p>
                </div>
            </div>

            <div class="mt-8 px-3 space-y-1">
                <button onclick="setView('new')" id="nav-new" class="nav-btn active w-full flex items-center gap-4 px-4 py-3 bg-brand-800 text-white rounded-xl border border-gray-700 transition-all">
                    <i class="fa-solid fa-circle-plus text-brand-400"></i>
                    <span class="hidden lg:block font-medium">New Project</span>
                </button>
                <button onclick="setView('history')" id="nav-history" class="nav-btn w-full flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white hover:bg-brand-800/50 rounded-xl transition-all">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    <span class="hidden lg:block font-medium">Past Orders</span>
                </button>
            </div>
        </div>

        <div class="p-4 border-t border-gray-800 bg-brand-950/50">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="logout()">
                <div class="w-9 h-9 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-xs font-bold ring-2 ring-brand-900 group-hover:ring-brand-500 transition-all" id="avatar">?</div>
                <div class="hidden lg:block">
                    <p class="text-sm font-semibold truncate w-32" id="username">Guest User</p>
                    <p class="text-xs text-brand-400 group-hover:underline">Sign Out</p>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-1 flex flex-col relative bg-brand-950">
        
        <header class="md:hidden h-16 bg-brand-900 border-b border-gray-800 flex items-center justify-between px-4 z-30">
            <span class="font-bold text-lg">MAGIC<span class="text-brand-400">PRINTER</span></span>
            <button onclick="toggleCart()" class="relative p-2">
                <i class="fa-solid fa-basket-shopping text-gray-300"></i>
                <span id="mobile-badge" class="absolute top-1 right-0 bg-brand-600 text-[9px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</span>
            </button>
        </header>

        <div id="login-modal" class="fixed inset-0 z-50 bg-brand-950/95 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-brand-900 border border-gray-700 rounded-2xl shadow-2xl p-8">
                <div class="text-center mb-8">
                    <div class="w-14 h-14 bg-brand-600 rounded-xl mx-auto flex items-center justify-center mb-4 text-2xl"><i class="fa-solid fa-print"></i></div>
                    <h2 class="text-2xl font-bold">Client Portal</h2>
                    <p class="text-gray-400 text-sm">Log in to manage your print orders</p>
                </div>
                <div class="space-y-4">
                    <input type="text" id="login-name" class="w-full bg-brand-950 border border-gray-700 rounded-xl p-3 focus:border-brand-500 focus:outline-none" placeholder="Company / Name">
                    <input type="email" id="login-email" class="w-full bg-brand-950 border border-gray-700 rounded-xl p-3 focus:border-brand-500 focus:outline-none" placeholder="Email Address">
                    <button onclick="handleLogin()" class="w-full bg-brand-600 hover:bg-brand-500 py-3 rounded-xl font-bold transition-all">Enter Portal</button>
                </div>
            </div>
        </div>

        <div id="view-new" class="flex-1 flex flex-col lg:flex-row h-full">
            
            <div class="flex-1 relative bg-[#0f1218] flex flex-col overflow-hidden">
                <div class="h-14 border-b border-gray-800 flex items-center justify-between px-6 bg-brand-900/50">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Visual Preview</span>
                    <div class="flex gap-2">
                         <span id="file-badge" class="hidden text-xs bg-gray-800 border border-gray-700 px-2 py-1 rounded text-gray-300"></span>
                         <button onclick="resetJob()" class="text-gray-500 hover:text-red-500 text-sm px-2"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>

                <div class="flex-1 flex items-center justify-center p-8 overflow-auto relative" id="stage-container">
                    
                    <div id="drop-zone" class="absolute inset-4 border-2 border-dashed border-gray-700 rounded-2xl flex flex-col items-center justify-center transition-all hover:border-brand-500 hover:bg-gray-800/30 cursor-pointer z-10">
                        <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-200">Upload Files</h3>
                        <p class="text-sm text-gray-500 mt-2">PDF, JPG, PNG, TIFF</p>
                        <button class="mt-6 px-6 py-2 bg-brand-600 rounded-full text-sm font-medium hover:bg-brand-500">Browse Device</button>
                        <input type="file" id="file-input" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.tiff">
                    </div>

                    <div id="paper-mockup" class="hidden relative bg-white transition-all duration-500 paper-shadow">
                        <canvas id="main-canvas" class="w-full h-full object-contain block"></canvas>
                        
                        <div id="finish-staple-tl" class="staple-mark hidden" style="top:12px; left:12px; transform:rotate(-45deg);"></div>
                        <div id="finish-staple-tr" class="staple-mark hidden" style="top:12px; right:12px; transform:rotate(45deg);"></div>
                        <div id="finish-punch-2" class="hidden absolute left-2 top-0 h-full flex flex-col justify-around py-10"><div class="punch-hole"></div><div class="punch-hole"></div></div>
                        <div id="finish-punch-3" class="hidden absolute left-2 top-0 h-full flex flex-col justify-around py-4"><div class="punch-hole"></div><div class="punch-hole"></div><div class="punch-hole"></div></div>
                        <div id="finish-fold-c" class="fold-line hidden" style="left:50%;"></div>
                    </div>
                </div>
            </div>

            <div class="w-full lg:w-[400px] bg-brand-900 border-l border-gray-800 flex flex-col h-full overflow-hidden">
                <div class="p-5 border-b border-gray-800 bg-brand-900 z-10">
                    <h2 class="font-bold text-white">Print Settings</h2>
                    <p class="text-xs text-gray-500">Kyocera TASKalfa / Ecosys Driver</p>
                </div>

                <div class="flex-1 overflow-y-auto p-5 space-y-8 opacity-50 pointer-events-none transition-opacity" id="controls-panel">
                    
                    <div class="space-y-3">
                        <label class="text-xs font-bold text-brand-400 uppercase tracking-wider">Media & Layout</label>
                        
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setSize('letter')" id="sz-letter" class="size-btn active bg-brand-800 border border-brand-500 rounded-lg p-2 text-center hover:bg-gray-800">
                                <div class="text-xs font-bold">Letter</div>
                                <div class="text-[9px] text-gray-400">8.5 x 11</div>
                            </button>
                            <button onclick="setSize('legal')" id="sz-legal" class="size-btn bg-brand-950 border border-gray-700 rounded-lg p-2 text-center hover:bg-gray-800">
                                <div class="text-xs font-bold">Legal</div>
                                <div class="text-[9px] text-gray-400">8.5 x 14</div>
                            </button>
                            <button onclick="setSize('tabloid')" id="sz-tabloid" class="size-btn bg-brand-950 border border-gray-700 rounded-lg p-2 text-center hover:bg-gray-800">
                                <div class="text-xs font-bold">Tabloid</div>
                                <div class="text-[9px] text-gray-400">11 x 17</div>
                            </button>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                             <select id="paper-stock" class="bg-brand-950 border border-gray-700 rounded-lg p-2.5 text-sm focus:border-brand-500 outline-none">
                                <option value="plain">Plain (20lb)</option>
                                <option value="bond">Bond (24lb)</option>
                                <option value="cardstock">Cardstock (100lb)</option>
                                <option value="glossy">Glossy / Coated</option>
                                <option value="label">Adhesive Label</option>
                            </select>
                            <select id="print-color" onchange="calcPrice()" class="bg-brand-950 border border-gray-700 rounded-lg p-2.5 text-sm focus:border-brand-500 outline-none">
                                <option value="bw">Black & White</option>
                                <option value="color">Full Color (CMYK)</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <label class="text-xs font-bold text-brand-400 uppercase tracking-wider">Finishing Options</label>
                        
                        <select id="finishing" onchange="updateFinish()" class="w-full bg-brand-950 border border-gray-700 rounded-lg p-3 text-sm focus:border-brand-500 outline-none">
                            <option value="none">No Finishing (Collate)</option>
                            <option value="staple-tl">Staple: Top-Left Corner</option>
                            <option value="staple-dual">Staple: Dual (Left Edge)</option>
                            <option value="punch-2">Hole Punch: 2-Hole</option>
                            <option value="punch-3">Hole Punch: 3-Hole</option>
                            <option value="fold-tri">Tri-Fold (Marketing)</option>
                            <option value="booklet">Saddle Stitch Booklet</option>
                        </select>

                        <div class="flex items-center justify-between bg-brand-950 p-3 rounded-lg border border-gray-700">
                            <span class="text-sm text-gray-300">Double Sided (Duplex)</span>
                            <button onclick="toggleDuplex()" id="btn-duplex" class="w-10 h-5 bg-gray-700 rounded-full relative transition-colors">
                                <div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform"></div>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-3">
                         <label class="text-xs font-bold text-brand-400 uppercase tracking-wider">Instructions</label>
                         <div class="flex gap-3">
                             <div class="w-1/3">
                                 <label class="text-[10px] text-gray-500 uppercase">Copies</label>
                                 <input type="number" id="qty" value="1" min="1" onchange="calcPrice()" class="w-full bg-brand-950 border border-gray-700 rounded-lg p-2 text-center text-white focus:border-brand-500 outline-none">
                             </div>
                             <div class="w-2/3">
                                <label class="text-[10px] text-gray-500 uppercase">Special Instructions</label>
                                <input type="text" id="notes" placeholder="e.g. Cut to bleed..." class="w-full bg-brand-950 border border-gray-700 rounded-lg p-2 text-sm focus:border-brand-500 outline-none">
                             </div>
                         </div>
                    </div>

                </div>

                <div class="p-5 border-t border-gray-800 bg-brand-900/90 backdrop-blur-md">
                    <div class="flex justify-between items-end mb-4">
                        <div>
                            <p class="text-xs text-gray-500">Unit Cost</p>
                            <p class="font-bold text-gray-300 text-sm" id="unit-cost">$0.10 / ea</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500">Subtotal</p>
                            <p class="font-bold text-2xl text-white" id="total-price">$0.00</p>
                        </div>
                    </div>
                    <button onclick="addToCart()" id="btn-add" disabled class="w-full py-3.5 bg-white hover:bg-gray-100 text-brand-950 font-bold rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2">
                        <span>Add to Project</span>
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="view-history" class="hidden flex-1 p-8 overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6">Past Orders</h2>
            <div id="history-list" class="grid gap-4 max-w-5xl"></div>
        </div>

    </main>

    <div id="cart-drawer" class="fixed inset-y-0 right-0 w-full md:w-[450px] bg-brand-900 border-l border-gray-700 shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col">
        <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-brand-950">
            <div>
                <h2 class="font-bold text-lg text-white">Project Summary</h2>
                <p class="text-xs text-gray-500">Review items before submission</p>
            </div>
            <button onclick="toggleCart()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
        </div>

        <div class="p-6 bg-brand-800/30 border-b border-gray-800 space-y-3">
             <div class="grid grid-cols-2 gap-3">
                 <div>
                     <label class="text-[10px] text-gray-500 uppercase font-bold">PO / Reference #</label>
                     <input type="text" id="po-ref" placeholder="Optional" class="w-full bg-brand-950 border border-gray-700 rounded-lg p-2 text-sm focus:border-brand-500 outline-none">
                 </div>
                 <div>
                     <label class="text-[10px] text-gray-500 uppercase font-bold">Due Date</label>
                     <select id="due-date" class="w-full bg-brand-950 border border-gray-700 rounded-lg p-2 text-sm focus:border-brand-500 outline-none">
                         <option>Standard (24h)</option>
                         <option>Rush (4h)</option>
                         <option>Economy (3 Days)</option>
                     </select>
                 </div>
             </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 space-y-4" id="cart-items"></div>

        <div class="p-6 bg-brand-950 border-t border-gray-800">
            <div class="flex justify-between mb-4">
                <span class="text-gray-400">Total Estimate</span>
                <span class="font-bold text-xl text-brand-400" id="cart-total">$0.00</span>
            </div>
            <button onclick="submitOrder()" id="btn-submit" disabled class="w-full py-4 bg-brand-600 hover:bg-brand-500 text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 transition-all disabled:opacity-50">
                Submit Order
            </button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const PRICING = {
            letter: { bw: 0.10, color: 0.35 },
            legal: { bw: 0.15, color: 0.45 },
            tabloid: { bw: 0.25, color: 0.75 },
            stock: { plain: 0, bond: 0.05, cardstock: 0.15, glossy: 0.20, label: 0.50 },
            finish: { none: 0, 'staple-tl': 0.02, 'staple-dual': 0.03, 'punch-2': 0.01, 'punch-3': 0.01, 'fold-tri': 0.10, booklet: 0.35 }
        };

        const PAPER_DIMS = { // Pixels for mock display (approx 1in = 40px)
            letter: { w: 340, h: 440 },
            legal: { w: 340, h: 560 },
            tabloid: { w: 440, h: 680 }
        };

        // --- STATE ---
        let state = {
            user: null,
            job: {
                file: null, type: null, pages: 1, 
                size: 'letter', stock: 'plain', color: 'bw', 
                finish: 'none', duplex: false, copies: 1, notes: ''
            },
            cart: [],
            history: JSON.parse(localStorage.getItem('mp_history')) || []
        };

        // --- AUTH ---
        if(localStorage.getItem('mp_user')) {
            state.user = JSON.parse(localStorage.getItem('mp_user'));
            updateUserUI();
            document.getElementById('login-modal').classList.add('hidden');
        }

        function handleLogin() {
            const name = document.getElementById('login-name').value;
            const email = document.getElementById('login-email').value;
            if(!name) return;
            state.user = { name, email };
            localStorage.setItem('mp_user', JSON.stringify(state.user));
            updateUserUI();
            document.getElementById('login-modal').classList.add('hidden');
        }

        function logout() {
            localStorage.removeItem('mp_user');
            location.reload();
        }

        function updateUserUI() {
            document.getElementById('username').innerText = state.user.name;
            document.getElementById('avatar').innerText = state.user.name.substring(0,2).toUpperCase();
            renderHistory();
        }

        // --- UPLOAD ENGINE ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-brand-500'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-brand-500'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-brand-500');
            if(e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if(e.target.files[0]) processFile(e.target.files[0]); });

        async function processFile(file) {
            const validTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/tiff'];
            if(!validTypes.includes(file.type)) return Swal.fire('Format Error', 'Please upload PDF, JPG, or PNG.', 'error');

            state.job.file = file;
            state.job.type = file.type.includes('pdf') ? 'pdf' : 'img';
            
            // UI Update
            document.getElementById('drop-zone').classList.add('hidden');
            document.getElementById('paper-mockup').classList.remove('hidden');
            document.getElementById('controls-panel').classList.remove('opacity-50', 'pointer-events-none');
            document.getElementById('btn-add').disabled = false;
            document.getElementById('file-badge').innerText = file.type.split('/')[1].toUpperCase();
            document.getElementById('file-badge').classList.remove('hidden');

            renderVisualizer();
            calcPrice();
        }

        async function renderVisualizer() {
            const canvas = document.getElementById('main-canvas');
            const ctx = canvas.getContext('2d');
            const dims = PAPER_DIMS[state.job.size];
            
            // Resize Container
            const mockup = document.getElementById('paper-mockup');
            mockup.style.width = dims.w + 'px';
            mockup.style.height = dims.h + 'px';
            
            // Resize Canvas
            canvas.width = dims.w * 2; // HiDPI
            canvas.height = dims.h * 2;
            
            ctx.clearRect(0,0, canvas.width, canvas.height);

            if(state.job.type === 'pdf') {
                const buffer = await state.job.file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                state.job.pages = pdf.numPages;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: canvas.width / page.getViewport({scale:1}).width });
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            } else {
                state.job.pages = 1;
                const img = new Image();
                img.onload = () => {
                    // "Fit to Page" Logic
                    const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                    const x = (canvas.width / 2) - (img.width / 2) * scale;
                    const y = (canvas.height / 2) - (img.height / 2) * scale;
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                };
                img.src = URL.createObjectURL(state.job.file);
            }
        }

        // --- CONTROLS LOGIC ---
        function setSize(sz) {
            state.job.size = sz;
            document.querySelectorAll('.size-btn').forEach(b => {
                b.classList.remove('active', 'bg-brand-800', 'border-brand-500');
                b.classList.add('bg-brand-950', 'border-gray-700');
            });
            document.getElementById('sz-'+sz).classList.add('active', 'bg-brand-800', 'border-brand-500');
            renderVisualizer();
            calcPrice();
        }

        function updateFinish() {
            const val = document.getElementById('finishing').value;
            state.job.finish = val;
            
            // Hide all marks
            document.querySelectorAll('.staple-mark, .punch-hole, .fold-line, #finish-punch-2, #finish-punch-3').forEach(e => e.classList.add('hidden'));
            document.getElementById('finish-fold-c').classList.add('hidden');

            if(val === 'staple-tl') document.getElementById('finish-staple-tl').classList.remove('hidden');
            if(val === 'staple-dual') {
                document.getElementById('finish-staple-tl').classList.remove('hidden');
                document.getElementById('finish-staple-tl').style.transform = 'rotate(0deg)';
                document.getElementById('finish-staple-tl').style.top = '25%';
                // Add second staple visually via JS if needed, simplifying for demo
            }
            if(val === 'punch-2') document.getElementById('finish-punch-2').classList.remove('hidden');
            if(val === 'punch-3') document.getElementById('finish-punch-3').classList.remove('hidden');
            if(val === 'booklet' || val === 'fold-tri') document.getElementById('finish-fold-c').classList.remove('hidden');
            
            calcPrice();
        }

        function toggleDuplex() {
            state.job.duplex = !state.job.duplex;
            const btn = document.getElementById('btn-duplex');
            if(state.job.duplex) {
                btn.classList.replace('bg-gray-700', 'bg-brand-500');
                btn.firstElementChild.classList.add('translate-x-5');
            } else {
                btn.classList.replace('bg-brand-500', 'bg-gray-700');
                btn.firstElementChild.classList.remove('translate-x-5');
            }
            calcPrice();
        }

        function calcPrice() {
            state.job.stock = document.getElementById('paper-stock').value;
            state.job.color = document.getElementById('print-color').value;
            state.job.copies = parseInt(document.getElementById('qty').value) || 1;
            state.job.notes = document.getElementById('notes').value;

            const base = PRICING[state.job.size][state.job.color];
            const stockCost = PRICING.stock[state.job.stock];
            const finishCost = PRICING.finish[state.job.finish];
            
            let unit = base + stockCost + finishCost;
            if(state.job.duplex) unit *= 1.8; // Duplex discount (not 2x)
            
            const total = unit * state.job.pages * state.job.copies;
            state.job.unitCost = unit;
            state.job.totalCost = total;

            document.getElementById('unit-cost').innerText = '$' + unit.toFixed(2) + ' / sht';
            document.getElementById('total-price').innerText = '$' + total.toFixed(2);
        }

        function resetJob() {
            state.job.file = null;
            document.getElementById('paper-mockup').classList.add('hidden');
            document.getElementById('drop-zone').classList.remove('hidden');
            document.getElementById('controls-panel').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('btn-add').disabled = true;
            document.getElementById('file-badge').classList.add('hidden');
            document.getElementById('file-input').value = '';
        }

        // --- CART LOGIC ---
        function addToCart() {
            // Clone job to cart
            state.cart.push({ ...state.job, id: Date.now() });
            updateCartUI();
            resetJob();
            toggleCart(true);
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            const badge = document.getElementById('mobile-badge');
            let grandTotal = 0;
            
            badge.innerText = state.cart.length;
            badge.classList.toggle('hidden', state.cart.length === 0);
            document.getElementById('btn-submit').disabled = state.cart.length === 0;

            if(state.cart.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-600 mt-10"><i class="fa-solid fa-folder-open text-4xl mb-2"></i><p>No items in project</p></div>';
                document.getElementById('cart-total').innerText = '$0.00';
                return;
            }

            let html = '';
            state.cart.forEach((item, idx) => {
                grandTotal += item.totalCost;
                html += `
                <div class="bg-brand-800 p-4 rounded-xl border border-gray-700 relative group">
                    <button onclick="remItem(${idx})" class="absolute top-2 right-2 text-gray-500 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-xmark"></i></button>
                    <div class="flex gap-3">
                        <div class="w-10 h-10 rounded bg-gray-700 flex items-center justify-center text-lg">
                            ${item.type === 'pdf' ? '<i class="fa-solid fa-file-pdf text-red-400"></i>' : '<i class="fa-solid fa-image text-blue-400"></i>'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-sm truncate">${item.file.name}</p>
                            <p class="text-[10px] text-gray-400 uppercase">${item.size} • ${item.stock} • ${item.color}</p>
                            <p class="text-[10px] text-brand-400 mt-1">${item.pages} Pages x ${item.copies} Copies</p>
                        </div>
                        <div class="font-bold text-right">$${item.totalCost.toFixed(2)}</div>
                    </div>
                    ${item.notes ? `<div class="mt-2 pt-2 border-t border-gray-700 text-[10px] text-yellow-500"><i class="fa-solid fa-note-sticky mr-1"></i>${item.notes}</div>` : ''}
                </div>`;
            });

            container.innerHTML = html;
            document.getElementById('cart-total').innerText = '$' + grandTotal.toFixed(2);
        }

        function remItem(idx) {
            state.cart.splice(idx, 1);
            updateCartUI();
        }

        function toggleCart(force) {
            const el = document.getElementById('cart-drawer');
            if(force) el.classList.remove('translate-x-full');
            else el.classList.toggle('translate-x-full');
        }

        function submitOrder() {
            const po = document.getElementById('po-ref').value || 'None';
            const due = document.getElementById('due-date').value;
            
            Swal.fire({
                title: 'Submit Project?',
                html: `<div class="text-left text-sm">
                       <p><strong>PO Reference:</strong> ${po}</p>
                       <p><strong>Due:</strong> ${due}</p>
                       <p><strong>Items:</strong> ${state.cart.length}</p>
                       </div>`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#2563eb',
                confirmButtonText: 'Confirm Order',
                background: '#111827', color: '#fff'
            }).then((res) => {
                if(res.isConfirmed) {
                    const order = {
                        id: 'JOB-' + Math.floor(Math.random()*100000),
                        date: new Date().toLocaleDateString(),
                        po: po,
                        total: document.getElementById('cart-total').innerText,
                        status: 'Received'
                    };
                    state.history.unshift(order);
                    localStorage.setItem('mp_history', JSON.stringify(state.history));
                    state.cart = [];
                    updateCartUI();
                    toggleCart();
                    setView('history');
                    Swal.fire({title: 'Received!', text: 'Job ticket sent to production.', icon: 'success', background: '#111827', color: '#fff'});
                }
            });
        }

        // --- NAVIGATION ---
        function setView(v) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active', 'bg-brand-800', 'text-white'));
            if(v === 'new') {
                document.getElementById('nav-new').classList.add('active', 'bg-brand-800', 'text-white');
                document.getElementById('view-new').classList.remove('hidden');
                document.getElementById('view-history').classList.add('hidden');
            } else {
                document.getElementById('nav-history').classList.add('active', 'bg-brand-800', 'text-white');
                document.getElementById('view-new').classList.add('hidden');
                document.getElementById('view-history').classList.remove('hidden');
                renderHistory();
            }
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            if(state.history.length === 0) return list.innerHTML = '<p class="text-gray-500">No history found.</p>';
            
            list.innerHTML = state.history.map(o => `
                <div class="bg-gray-900 border border-gray-800 p-4 rounded-xl flex justify-between items-center">
                    <div>
                        <p class="font-bold text-brand-400">${o.id}</p>
                        <p class="text-xs text-gray-500">${o.date} • PO: ${o.po}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-white">${o.total}</p>
                        <span class="text-[10px] bg-blue-900/50 text-blue-300 px-2 py-1 rounded border border-blue-800">${o.status}</span>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
