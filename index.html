<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Printer | Smart Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 950: '#0b0f19', 900: '#111827', 800: '#1f2937', 600: '#2563eb', 500: '#3b82f6' }
                    }
                }
            }
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0b0f19; color: white; -webkit-tap-highlight-color: transparent; }
        
        /* Editor Polish */
        .cropper-view-box { outline: 1px solid #3b82f6; }
        .cropper-modal { background-color: #0b0f19; opacity: 0.85; }
        .cropper-bg { background: #1a1d24; } /* Hides the checkerboard for a cleaner look */
        
        /* Orientation Transition */
        #editor-wrapper { transition: all 0.3s ease; }
        
        /* Kyocera Overlays */
        .safety-zone { border: 1px dashed rgba(239, 68, 68, 0.4); position: absolute; pointer-events: none; z-index: 40; }
        .safety-label { position: absolute; font-size: 8px; color: rgba(239, 68, 68, 0.6); text-transform: uppercase; font-weight: bold; top: 2px; right: 2px; }
        .staple { position: absolute; background: linear-gradient(to right, #ccc, #fff, #ccc); box-shadow: 1px 1px 3px rgba(0,0,0,0.5); z-index: 50; }
        .punch { position: absolute; background: #0b0f19; border: 1px solid #333; border-radius: 50%; z-index: 50; }

        /* AI Badge Animation */
        .ai-pulse { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden">

    <header class="h-14 bg-brand-900 border-b border-gray-800 flex items-center justify-between px-4 shrink-0 z-50">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-brand-600 rounded flex items-center justify-center shadow-lg shadow-blue-900/20"><i class="fa-solid fa-wand-magic-sparkles text-white text-xs"></i></div>
            <div class="leading-none">
                <h1 class="font-bold tracking-tight text-sm">MAGIC<span class="text-brand-500">PRINTER</span></h1>
                <span class="text-[9px] text-gray-500 uppercase tracking-widest font-bold">Smart Lab</span>
            </div>
        </div>
        <button onclick="toggleCart()" class="relative p-2">
            <i class="fa-solid fa-layer-group text-gray-400"></i>
            <span id="cart-badge" class="absolute top-0 right-0 bg-brand-500 text-[9px] w-4 h-4 rounded-full flex items-center justify-center hidden shadow-sm border border-brand-900">0</span>
        </button>
    </header>

    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">

        <div class="flex-1 bg-[#0f1218] relative flex flex-col">
            
            <div id="smart-alert" class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-brand-800/90 backdrop-blur border border-brand-500 text-brand-100 px-4 py-2 rounded-full text-xs font-bold shadow-2xl z-[60] flex items-center gap-2 hidden transition-all">
                <i class="fa-solid fa-robot text-brand-400"></i>
                <span id="smart-msg">Auto-detected Landscape Mode</span>
            </div>

            <div id="editor-toolbar" class="h-12 bg-brand-950/80 border-b border-gray-800 flex items-center justify-center gap-6 px-4 hidden z-40 backdrop-blur-sm">
                <button onclick="rotateImage(-90)" class="text-gray-400 hover:text-white transition-colors" title="Rotate Image"><i class="fa-solid fa-arrow-rotate-left"></i></button>
                <div class="w-px h-4 bg-gray-700"></div>
                <button onclick="setFit('cover')" id="tool-cover" class="text-brand-500 font-bold text-xs uppercase hover:text-white transition-colors">Fill Page</button>
                <button onclick="setFit('contain')" id="tool-contain" class="text-gray-400 font-bold text-xs uppercase hover:text-white transition-colors">Fit Inside</button>
                <div class="w-px h-4 bg-gray-700"></div>
                <button onclick="resetEditor()" class="text-red-400 hover:text-red-300 transition-colors"><i class="fa-solid fa-trash"></i></button>
            </div>

            <div class="flex-1 relative overflow-hidden flex items-center justify-center bg-[#15181e] p-4 lg:p-8">
                
                <div id="upload-state" class="text-center w-full max-w-sm">
                    <div onclick="document.getElementById('file-input').click()" class="aspect-video border-2 border-dashed border-gray-700 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-brand-500 hover:bg-brand-900/10 transition-all group">
                        <div class="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform shadow-xl">
                            <i class="fa-solid fa-cloud-arrow-up text-2xl text-gray-400 group-hover:text-brand-400"></i>
                        </div>
                        <h3 class="font-bold text-gray-200">Drop File Here</h3>
                        <p class="text-xs text-gray-500 mt-2">Auto-Analysis Active</p>
                    </div>
                    <input type="file" id="file-input" class="hidden" accept=".pdf,.jpg,.jpeg,.png">
                </div>

                <div id="editor-container" class="hidden w-full h-full relative flex items-center justify-center">
                    <div class="shadow-2xl paper-glow max-h-full max-w-full" id="editor-wrapper">
                        <img id="image-target" src="" class="block max-w-full">
                    </div>
                    <div id="finish-layer" class="finish-overlay absolute inset-0 pointer-events-none z-50"></div>
                </div>
            </div>
        </div>

        <div class="h-[50vh] lg:h-auto lg:w-[360px] bg-brand-900 border-t lg:border-t-0 lg:border-l border-gray-800 flex flex-col z-50 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
            
            <div class="flex-1 overflow-y-auto p-5 space-y-6">
                
                <div class="bg-brand-950 p-1 rounded-lg border border-gray-800 flex">
                    <button onclick="setOrientation('portrait')" id="btn-portrait" class="flex-1 py-2 rounded-md text-xs font-bold flex items-center justify-center gap-2 transition-all active bg-brand-800 text-white shadow">
                        <i class="fa-regular fa-file"></i> Portrait
                    </button>
                    <button onclick="setOrientation('landscape')" id="btn-landscape" class="flex-1 py-2 rounded-md text-xs font-bold flex items-center justify-center gap-2 text-gray-400 hover:text-white transition-all">
                        <i class="fa-regular fa-file fa-rotate-90"></i> Landscape
                    </button>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Paper Size</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setPaper('letter')" id="btn-letter" class="paper-btn active p-3 rounded-lg border border-brand-500 bg-brand-800 flex flex-col items-center gap-1 transition-all">
                            <span class="text-xs font-bold text-white">Letter</span>
                            <span class="text-[9px] text-gray-400">8.5 x 11</span>
                        </button>
                        <button onclick="setPaper('legal')" id="btn-legal" class="paper-btn p-3 rounded-lg border border-gray-700 bg-brand-950 flex flex-col items-center gap-1 transition-all hover:bg-brand-800">
                            <span class="text-xs font-bold text-gray-400">Legal</span>
                            <span class="text-[9px] text-gray-500">8.5 x 14</span>
                        </button>
                        <button onclick="setPaper('tabloid')" id="btn-tabloid" class="paper-btn p-3 rounded-lg border border-gray-700 bg-brand-950 flex flex-col items-center gap-1 transition-all hover:bg-brand-800">
                            <span class="text-xs font-bold text-gray-400">Tabloid</span>
                            <span class="text-[9px] text-gray-500">11 x 17</span>
                        </button>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Finishing</label>
                    <div class="relative">
                        <select id="finish-opt" onchange="updateFinish()" class="w-full bg-brand-950 border border-gray-700 rounded-lg h-11 px-3 text-sm text-gray-200 focus:border-brand-500 outline-none appearance-none">
                            <option value="none">No Finishing</option>
                            <option value="staple-tl">Staple: Top Left</option>
                            <option value="punch-3">3-Hole Punch</option>
                            <option value="booklet">Booklet Fold</option>
                        </select>
                        <div class="absolute right-3 top-3 text-gray-500 pointer-events-none"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-2">
                    <span class="text-xs font-bold text-gray-400 uppercase">Quantity</span>
                    <div class="flex items-center gap-3 bg-brand-950 p-1 rounded-lg border border-gray-800">
                        <button onclick="adjQty(-1)" class="w-8 h-8 rounded bg-brand-800 hover:bg-brand-700 text-white">-</button>
                        <span id="qty-disp" class="font-mono font-bold w-6 text-center">1</span>
                        <button onclick="adjQty(1)" class="w-8 h-8 rounded bg-brand-800 hover:bg-brand-700 text-white">+</button>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-800 bg-brand-950 pb-safe">
                <button onclick="addToCart()" id="btn-add" disabled class="w-full h-12 bg-white hover:bg-gray-100 text-brand-950 font-bold rounded-xl shadow-lg flex items-center justify-between px-6 disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-[0.98]">
                    <span>Add to Order</span>
                    <span id="price-disp">$0.10</span>
                </button>
            </div>
        </div>
    </main>

    <div id="cart-overlay" class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm hidden transition-opacity" onclick="toggleCart()"></div>
    <div id="cart-drawer" class="fixed right-0 top-0 h-full w-full max-w-sm bg-brand-900 shadow-2xl z-[70] transform translate-x-full transition-transform duration-300 flex flex-col border-l border-gray-800">
        <div class="p-5 border-b border-gray-800 flex justify-between items-center bg-brand-950">
            <h2 class="font-bold text-lg">Your Cart</h2>
            <button onclick="toggleCart()" class="w-8 h-8 rounded-full bg-gray-800 hover:bg-gray-700 flex items-center justify-center text-gray-400"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="cart-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
        <div class="p-5 border-t border-gray-800 bg-brand-950 mb-safe">
            <div class="flex justify-between font-bold mb-4 text-lg">
                <span class="text-gray-400">Total</span>
                <span id="cart-total" class="text-white">$0.00</span>
            </div>
            <button onclick="checkout()" class="w-full h-14 bg-brand-600 hover:bg-brand-500 rounded-xl font-bold text-white shadow-lg shadow-blue-900/20 active:scale-95 transition-all">Submit Order</button>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const DIMS = { 
            letter: { w: 8.5, h: 11 }, 
            legal: { w: 8.5, h: 14 }, 
            tabloid: { w: 11, h: 17 } 
        };
        const PRICES = { letter: 0.10, legal: 0.15, tabloid: 0.25 };
        
        // --- STATE ---
        let cropper = null;
        let state = {
            size: 'letter',
            orient: 'portrait', // 'portrait' | 'landscape'
            finish: 'none',
            qty: 1,
            fit: 'cover'
        };
        let cart = [];

        // --- CORE UPLOAD & ANALYSIS ---
        const fileInput = document.getElementById('file-input');
        fileInput.addEventListener('change', (e) => { if(e.target.files[0]) processFile(e.target.files[0]); });

        async function processFile(file) {
            let src = '';
            
            // 1. PDF Handling
            if(file.type.includes('pdf')) {
                const buff = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buff).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 2 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                src = canvas.toDataURL('image/jpeg');
            } else {
                src = URL.createObjectURL(file);
            }

            // 2. Pre-Load Image to Analyze Dimensions
            const img = new Image();
            img.onload = () => {
                analyzeAndSetup(img, src, file.name);
            };
            img.src = src;
        }

        function analyzeAndSetup(img, src, fname) {
            // A. Smart Orientation Detection
            const isWide = img.naturalWidth > img.naturalHeight;
            state.orient = isWide ? 'landscape' : 'portrait';
            
            // B. Smart Size Suggestion
            const ratio = isWide ? (img.naturalWidth / img.naturalHeight) : (img.naturalHeight / img.naturalWidth);
            let suggestedSize = 'letter';
            if (ratio > 1.4 && ratio < 1.7) suggestedSize = 'legal'; // Approx 1.64
            // if (ratio < 1.4) suggestedSize = 'tabloid'; // 11x17 is ~1.54, Letter is ~1.29. Keep letter default for standard.

            state.size = suggestedSize;

            // C. Show Smart Alert
            showSmartAlert(`Detected ${state.orient === 'landscape' ? 'Landscape' : 'Portrait'} • Suggesting ${suggestedSize.charAt(0).toUpperCase() + suggestedSize.slice(1)}`);

            // D. UI Updates
            updateOrientationUI();
            updatePaperUI();
            
            // E. Init Editor
            document.getElementById('image-target').src = src;
            document.getElementById('upload-state').classList.add('hidden');
            document.getElementById('editor-container').classList.remove('hidden');
            document.getElementById('editor-toolbar').classList.remove('hidden');
            document.getElementById('btn-add').disabled = false;
            
            initCropper();
        }

        function initCropper() {
            if(cropper) cropper.destroy();
            const el = document.getElementById('image-target');
            
            // Calculate Ratio based on Orientation + Size
            const base = DIMS[state.size];
            const ratio = state.orient === 'portrait' ? (base.w / base.h) : (base.h / base.w);

            cropper = new Cropper(el, {
                aspectRatio: ratio,
                viewMode: 1, // Restrict
                dragMode: 'move',
                autoCropArea: 1,
                guides: false,
                center: false,
                background: false, // Custom bg in CSS
                cropBoxMovable: false,
                cropBoxResizable: false,
                ready() {
                    setFit('cover'); // Default to full bleed
                    drawOverlays();
                },
                crop: drawOverlays // Re-draw staples on move
            });
        }

        // --- ACTIONS ---
        function setOrientation(o) {
            state.orient = o;
            updateOrientationUI();
            initCropper(); // Re-init with new ratio
            showSmartAlert(`Switched to ${o.charAt(0).toUpperCase() + o.slice(1)}`);
        }

        function setPaper(sz) {
            state.size = sz;
            updatePaperUI();
            initCropper();
            updatePrice();
        }

        function setFit(mode) {
            state.fit = mode;
            // Visual Toggle
            document.getElementById('tool-cover').className = mode === 'cover' ? 'text-brand-500 font-bold text-xs uppercase' : 'text-gray-500 font-bold text-xs uppercase hover:text-white';
            document.getElementById('tool-contain').className = mode === 'contain' ? 'text-brand-500 font-bold text-xs uppercase' : 'text-gray-500 font-bold text-xs uppercase hover:text-white';
            
            if(cropper) {
                // To simulate "Contain", we zoom out until the image fits. 
                // CropperJS is best at "Cover", so we reset.
                cropper.reset();
                if(mode === 'cover') {
                    // It defaults to cover/fit usually, but let's zoom in slightly
                    cropper.zoom(0); 
                }
            }
        }
        
        function rotateImage(deg) {
            if(cropper) cropper.rotate(deg);
        }

        function updateFinish() {
            state.finish = document.getElementById('finish-opt').value;
            drawOverlays();
            updatePrice();
        }

        // --- OVERLAYS ---
        function drawOverlays() {
            const layer = document.getElementById('finish-layer');
            layer.innerHTML = '';
            if(!cropper) return;
            
            const data = cropper.getCropBoxData();
            const { width, height, top, left } = data;

            // 1. Safety Zone (4mm approx = 15px)
            const safe = document.createElement('div');
            safe.className = 'safety-zone';
            safe.style.left = (left + 15) + 'px';
            safe.style.top = (top + 15) + 'px';
            safe.style.width = (width - 30) + 'px';
            safe.style.height = (height - 30) + 'px';
            safe.innerHTML = '<span class="safety-label">Safe Zone</span>';
            layer.appendChild(safe);

            // 2. Finishing
            if(state.finish.includes('staple')) {
                const s = document.createElement('div');
                s.className = 'staple';
                s.style.width = '30px'; s.style.height = '6px';
                // Rotate logic based on paper orientation
                s.style.top = (top + 15) + 'px';
                s.style.left = (left + 15) + 'px';
                s.style.transform = 'rotate(-45deg)';
                layer.appendChild(s);
            }
            if(state.finish.includes('punch')) {
                for(let i=1; i<=3; i++) {
                    const p = document.createElement('div');
                    p.className = 'punch';
                    p.style.width = '12px'; p.style.height = '12px';
                    p.style.left = (left + 8) + 'px';
                    p.style.top = (top + (height * (i/4))) + 'px';
                    layer.appendChild(p);
                }
            }
        }

        // --- UI HELPERS ---
        function updateOrientationUI() {
            const pBtn = document.getElementById('btn-portrait');
            const lBtn = document.getElementById('btn-landscape');
            if(state.orient === 'portrait') {
                pBtn.className = 'flex-1 py-2 rounded-md text-xs font-bold flex items-center justify-center gap-2 transition-all bg-brand-800 text-white shadow ring-1 ring-brand-500';
                lBtn.className = 'flex-1 py-2 rounded-md text-xs font-bold flex items-center justify-center gap-2 text-gray-400 hover:text-white';
            } else {
                lBtn.className = 'flex-1 py-2 rounded-md text-xs font-bold flex items-center justify-center gap-2 transition-all bg-brand-800 text-white shadow ring-1 ring-brand-500';
                pBtn.className = 'flex-1 py-2 rounded-md text-xs font-bold flex items-center justify-center gap-2 text-gray-400 hover:text-white';
            }
        }

        function updatePaperUI() {
            document.querySelectorAll('.paper-btn').forEach(b => {
                b.className = 'paper-btn p-3 rounded-lg border border-gray-700 bg-brand-950 flex flex-col items-center gap-1 transition-all hover:bg-brand-800';
                b.querySelector('span:first-child').className = 'text-xs font-bold text-gray-400';
            });
            const active = document.getElementById('btn-'+state.size);
            active.className = 'paper-btn active p-3 rounded-lg border border-brand-500 bg-brand-800 flex flex-col items-center gap-1 transition-all shadow-md';
            active.querySelector('span:first-child').className = 'text-xs font-bold text-white';
        }

        function showSmartAlert(msg) {
            const el = document.getElementById('smart-alert');
            document.getElementById('smart-msg').innerText = msg;
            el.classList.remove('hidden');
            el.classList.add('ai-pulse');
            setTimeout(() => {
                el.classList.add('hidden');
                el.classList.remove('ai-pulse');
            }, 4000);
        }

        // --- CART ---
        function adjQty(n) {
            state.qty = Math.max(1, state.qty + n);
            document.getElementById('qty-disp').innerText = state.qty;
            updatePrice();
        }

        function updatePrice() {
            const base = PRICES[state.size];
            const extra = state.finish === 'none' ? 0 : 0.05;
            const total = (base + extra) * state.qty;
            document.getElementById('price-disp').innerText = '$' + total.toFixed(2);
        }

        function addToCart() {
            cart.push({...state, total: document.getElementById('price-disp').innerText });
            updateCart();
            resetEditor();
            toggleCart();
        }

        function updateCart() {
            const list = document.getElementById('cart-list');
            document.getElementById('cart-badge').innerText = cart.length;
            document.getElementById('cart-badge').classList.remove('hidden');
            
            list.innerHTML = cart.map((item, i) => `
                <div class="bg-brand-800 p-3 rounded-xl border border-gray-700 flex justify-between items-center">
                    <div>
                        <div class="font-bold text-sm text-white">${item.size.toUpperCase()}</div>
                        <div class="text-[10px] text-gray-400 uppercase">${item.orient} • ${item.finish} • x${item.qty}</div>
                    </div>
                    <div class="font-bold text-brand-400">${item.total}</div>
                </div>
            `).join('');

            let t = 0;
            cart.forEach(c => t += parseFloat(c.total.replace('$','')));
            document.getElementById('cart-total').innerText = '$' + t.toFixed(2);
        }

        function toggleCart() {
            const drawer = document.getElementById('cart-drawer');
            const overlay = document.getElementById('cart-overlay');
            if(drawer.classList.contains('translate-x-full')) {
                drawer.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                drawer.classList.add('translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function resetEditor() {
            if(cropper) cropper.destroy();
            document.getElementById('editor-container').classList.add('hidden');
            document.getElementById('editor-toolbar').classList.add('hidden');
            document.getElementById('upload-state').classList.remove('hidden');
            document.getElementById('btn-add').disabled = true;
            document.getElementById('file-input').value = '';
        }

        function checkout() {
            Swal.fire({
                title: 'Sent!',
                text: 'Order successfully transmitted to Kyocera Queue.',
                icon: 'success',
                confirmButtonColor: '#2563eb',
                background: '#111827', color: '#fff'
            });
            cart = [];
            updateCart();
            toggleCart();
        }
    </script>
</body>
</html>
