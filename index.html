<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Printer | v20 Failsafe</title>
    
    <style>
        :root { --bg: #020617; --surface: #0f172a; --primary: #2563eb; --text: #fff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0; background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* Status Bar for Errors */
        #status-bar { background: #333; color: #ccc; font-size: 10px; padding: 4px 12px; text-align: center; display: none; }

        /* NAV */
        nav { 
            height: 60px; display: flex; align-items: center; justify-content: space-between; 
            padding: 0 16px; background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid #1e293b;
            position: sticky; top: 0; z-index: 50; backdrop-filter: blur(8px);
        }
        .logo { font-weight: 800; font-size: 16px; letter-spacing: -0.5px; }
        .logo span { color: var(--primary); }
        .icon-btn { width: 36px; height: 36px; border-radius: 50%; background: #1e293b; border: 1px solid #334155; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; }

        /* UPLOAD AREA */
        #view-upload { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; min-height: 60vh; }
        .drop-zone { 
            width: 100%; max-width: 320px; aspect-ratio: 1; 
            border: 2px dashed #334155; border-radius: 24px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #0f172a; transition: all 0.2s; cursor: pointer;
        }
        .drop-zone:active { background: #1e293b; border-color: var(--primary); transform: scale(0.98); }
        .drop-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .drop-title { font-weight: 700; font-size: 18px; margin-bottom: 4px; }
        .drop-sub { font-size: 13px; color: #94a3b8; }

        /* EDITOR AREA (Hidden by default) */
        #view-editor { display: none; flex-direction: column; width: 100%; }
        
        .canvas-container { 
            width: 100%; height: 50vh; background: #000; position: relative; 
            overflow: hidden; flex-shrink: 0;
        }
        #image-target { display: block; max-width: 100%; }

        /* FINISHING OVERLAYS */
        .overlay-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; overflow: hidden; }
        .mark-staple { position: absolute; width: 24px; height: 4px; background: linear-gradient(90deg, #ccc, #fff, #ccc); transform: rotate(-45deg); box-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .mark-punch { position: absolute; width: 12px; height: 12px; background: #020617; border: 1px solid #555; border-radius: 50%; }

        /* TOOLBAR */
        .toolbar { 
            display: flex; gap: 8px; justify-content: center; padding: 12px; 
            background: #0f172a; border-bottom: 1px solid #1e293b;
        }
        .tool-btn { 
            padding: 8px 16px; border-radius: 8px; background: #1e293b; border: 1px solid #334155; 
            color: #fff; font-size: 12px; font-weight: 600; cursor: pointer;
        }
        .tool-btn:active { background: var(--primary); border-color: var(--primary); }

        /* CONTROLS LIST */
        .controls { padding: 20px; padding-bottom: 120px; background: #020617; }
        .section-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 10px; display: block; letter-spacing: 0.5px; }
        
        .opt-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-bottom: 24px; }
        .opt-btn { 
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px; background: #0f172a; border: 2px solid #1e293b; 
            border-radius: 12px; color: #fff; cursor: pointer; text-align: left;
        }
        .opt-btn.active { border-color: var(--primary); background: #0f172a; }
        .opt-title { font-weight: 600; font-size: 14px; display: block; }
        .opt-sub { font-size: 11px; color: #64748b; margin-top: 2px; display: block; }
        .check-mark { display: none; color: var(--primary); font-weight: bold; }
        .opt-btn.active .check-mark { display: block; }

        /* FOOTER */
        .footer { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(15, 23, 42, 0.95); border-top: 1px solid #1e293b; 
            padding: 16px; padding-bottom: max(16px, env(safe-area-inset-bottom));
            display: flex; gap: 12px; z-index: 100; backdrop-filter: blur(10px);
        }
        .qty-ctrl { display: flex; background: #0f172a; border-radius: 8px; border: 1px solid #334155; overflow: hidden; }
        .qty-btn { width: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; cursor: pointer; background: transparent; color: #fff; border: none; }
        .qty-val { width: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; border-left: 1px solid #334155; border-right: 1px solid #334155; }
        .add-btn { 
            flex: 1; background: var(--primary); color: white; border: none; border-radius: 8px; 
            font-size: 16px; font-weight: 700; cursor: pointer;
        }
        .add-btn:disabled { background: #334155; color: #64748b; cursor: not-allowed; }

        /* Loader Overlay */
        #loader { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; 
            display: none; align-items: center; justify-content: center; flex-direction: column; 
        }
        .spinner { width: 32px; height: 32px; border: 3px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
</head>
<body>

    <div id="status-bar">System Ready</div>

    <nav>
        <div class="logo">MAGIC<span>PRINTER</span></div>
        <div style="display:flex; gap:8px;">
            <button class="icon-btn" onclick="alert('Profile')">üë§</button>
            <button class="icon-btn" onclick="alert('Cart')">üõí</button>
        </div>
    </nav>

    <div id="loader">
        <div class="spinner"></div>
        <div style="font-size:12px; font-weight:bold; color:#ccc">Processing...</div>
    </div>

    <div id="view-upload">
        <div class="drop-zone" onclick="document.getElementById('file-input').click()">
            <div class="drop-icon">‚òÅÔ∏è</div>
            <div class="drop-title">Upload File</div>
            <div class="drop-sub">PDF, JPG, PNG</div>
        </div>
        <input type="file" id="file-input" style="display:none" accept=".pdf,.jpg,.jpeg,.png,.webp">
    </div>

    <div id="view-editor">
        
        <div class="canvas-container">
            <img id="image-target" style="max-width:100%;">
            <div id="finish-layer" class="overlay-layer"></div>
        </div>

        <div class="toolbar">
            <button class="tool-btn" onclick="rotate(-90)">‚Ü∫ Rotate</button>
            <button class="tool-btn" onclick="fit('cover')">‚õ∂ Fill</button>
            <button class="tool-btn" onclick="fit('contain')">‚Üî Fit</button>
        </div>

        <div class="controls">
            
            <label class="section-label">Paper Size</label>
            <div class="opt-grid">
                <button class="opt-btn active" id="sz-letter" onclick="setSize('letter')">
                    <div><span class="opt-title">Letter</span><span class="opt-sub">8.5 x 11"</span></div>
                    <div class="check-mark">‚úî</div>
                </button>
                <button class="opt-btn" id="sz-legal" onclick="setSize('legal')">
                    <div><span class="opt-title">Legal</span><span class="opt-sub">8.5 x 14"</span></div>
                    <div class="check-mark">‚úî</div>
                </button>
                <button class="opt-btn" id="sz-tabloid" onclick="setSize('tabloid')">
                    <div><span class="opt-title">Tabloid</span><span class="opt-sub">11 x 17"</span></div>
                    <div class="check-mark">‚úî</div>
                </button>
            </div>

            <label class="section-label">Finishing</label>
            <div class="opt-grid">
                <button class="opt-btn active" id="fn-none" onclick="setFinish('none')">
                    <div><span class="opt-title">None</span><span class="opt-sub">Collate Only</span></div>
                    <div class="check-mark">‚úî</div>
                </button>
                <button class="opt-btn" id="fn-staple" onclick="setFinish('staple')">
                    <div><span class="opt-title">Staple</span><span class="opt-sub">Top Left Corner</span></div>
                    <div class="check-mark">‚úî</div>
                </button>
                <button class="opt-btn" id="fn-punch" onclick="setFinish('punch')">
                    <div><span class="opt-title">Hole Punch</span><span class="opt-sub">3-Hole Left</span></div>
                    <div class="check-mark">‚úî</div>
                </button>
                <button class="opt-btn" id="fn-booklet" onclick="setFinish('booklet')">
                    <div><span class="opt-title">Booklet</span><span class="opt-sub">Fold & Stitch</span></div>
                    <div class="check-mark">‚úî</div>
                </button>
            </div>

        </div>
    </div>

    <div class="footer">
        <div class="qty-ctrl">
            <button class="qty-btn" onclick="adjQty(-1)">-</button>
            <div class="qty-val" id="qty-val">1</div>
            <button class="qty-btn" onclick="adjQty(1)">+</button>
        </div>
        <button class="add-btn" id="btn-add" disabled onclick="submitOrder()">Add to Order (<span id="price-disp">$0.10</span>)</button>
    </div>

    <script>
        // Global Error Handler to catch crash issues
        window.onerror = function(msg, url, line) {
            const bar = document.getElementById('status-bar');
            bar.style.display = 'block';
            bar.style.background = '#991b1b';
            bar.innerText = "Error: " + msg;
            // Hide loader if stuck
            document.getElementById('loader').style.display = 'none';
        };

        // Configuration
        const DIMS = { letter: 8.5/11, legal: 8.5/14, tabloid: 11/17 };
        const PRICES = { letter: 0.10, legal: 0.15, tabloid: 0.25 };
        
        let cropper = null;
        let state = { size: 'letter', finish: 'none', qty: 1 };

        // File Handler
        document.getElementById('file-input').addEventListener('change', function(e) {
            if(!e.target.files[0]) return;
            const file = e.target.files[0];
            const loader = document.getElementById('loader');
            
            loader.style.display = 'flex';

            // SAFETY: Use a timeout to ensure UI updates before heavy processing
            setTimeout(async () => {
                try {
                    let src = '';
                    
                    // PDF Support (Check if library loaded)
                    if(file.type === 'application/pdf') {
                        if (typeof pdfjsLib === 'undefined') throw new Error("PDF Engine not ready. Wait 2s and try again.");
                        
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        const buff = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(buff).promise;
                        const page = await pdf.getPage(1);
                        const viewport = page.getViewport({ scale: 1.5 });
                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width; 
                        canvas.height = viewport.height;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                        src = canvas.toDataURL('image/jpeg');
                    } 
                    // Standard Image
                    else {
                        src = URL.createObjectURL(file);
                    }

                    // Load Image to Editor
                    const img = document.getElementById('image-target');
                    img.onload = () => {
                        loader.style.display = 'none';
                        document.getElementById('view-upload').style.display = 'none';
                        document.getElementById('view-editor').style.display = 'flex';
                        document.getElementById('btn-add').disabled = false;
                        
                        initCropper();
                    };
                    img.onerror = () => { throw new Error("Failed to load image data."); };
                    img.src = src;

                } catch (err) {
                    loader.style.display = 'none';
                    alert("Upload Error: " + err.message);
                }
            }, 100);
        });

        function initCropper() {
            if(cropper) cropper.destroy();
            const img = document.getElementById('image-target');
            if (typeof Cropper === 'undefined') { alert("Cropper Library not loaded."); return; }
            
            cropper = new Cropper(img, {
                aspectRatio: DIMS[state.size],
                viewMode: 1, // Restrict to box
                dragMode: 'move',
                autoCropArea: 1,
                background: false,
                ready() { updateOverlays(); }
            });
        }

        // Tools
        window.rotate = (deg) => { if(cropper) cropper.rotate(deg); };
        window.fit = (mode) => { if(cropper) cropper.reset(); }; // Simple reset for stability

        window.setSize = (sz) => {
            state.size = sz;
            updateUI('sz', sz);
            if(cropper) cropper.setAspectRatio(DIMS[sz]);
            updatePrice();
        };

        window.setFinish = (f) => {
            state.finish = f;
            updateUI('fn', f);
            updateOverlays();
            updatePrice();
        };

        function updateUI(prefix, val) {
            document.querySelectorAll(`[id^="${prefix}-"]`).forEach(el => {
                if(el.id === `${prefix}-${val}`) el.classList.add('active');
                else el.classList.remove('active');
            });
        }

        function updateOverlays() {
            const l = document.getElementById('finish-layer');
            l.innerHTML = '';
            if(!cropper) return;
            const box = cropper.getCropBoxData(); // Get positions relative to container
            
            if(state.finish === 'staple') {
                const s = document.createElement('div'); s.className = 'mark-staple';
                s.style.top = (box.top + 20) + 'px';
                s.style.left = (box.left + 20) + 'px';
                l.appendChild(s);
            }
            if(state.finish === 'punch') {
                for(let i=1; i<=3; i++) {
                    const p = document.createElement('div'); p.className = 'mark-punch';
                    p.style.left = (box.left + 10) + 'px';
                    p.style.top = (box.top + (box.height * (i/4))) + 'px';
                    l.appendChild(p);
                }
            }
        }

        window.adjQty = (n) => {
            state.qty = Math.max(1, state.qty + n);
            document.getElementById('qty-val').innerText = state.qty;
            updatePrice();
        };

        function updatePrice() {
            const p = PRICES[state.size] + (state.finish === 'none' ? 0 : 0.05);
            document.getElementById('price-disp').innerText = '$' + (p * state.qty).toFixed(2);
        }

        window.submitOrder = () => {
            if(typeof Swal !== 'undefined') {
                Swal.fire({ title: 'Success', text: 'Order Sent to Printer', icon: 'success' });
            } else {
                alert("Order Sent!");
            }
            setTimeout(() => location.reload(), 2000);
        };

    </script>
</body>
</html>
