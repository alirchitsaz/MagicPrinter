<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Magic Printer | HUD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { brand: { 900: '#111827', 800: '#1f2937', 600: '#2563eb', 500: '#3b82f6' } },
                    spacing: { 'safe-t': 'env(safe-area-inset-top)', 'safe-b': 'env(safe-area-inset-bottom)' }
                }
            }
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        /* LAYOUT */
        html, body { height: 100%; width: 100%; overflow: hidden; background: #000; font-family: 'Inter', sans-serif; color: white; touch-action: none; }
        
        /* CANVAS LAYER */
        #editor-layer { position: absolute; inset: 0; bottom: 220px; /* Leave room for HUD */ z-index: 0; background: #111; }
        .cropper-view-box { outline: 1px solid rgba(255,255,255,0.8); box-shadow: 0 0 0 9999px rgba(0,0,0,0.9); } 
        .cropper-bg { background: #e5e5e5; }

        /* HUD LAYER (Bottom Controls) */
        #hud-layer { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 220px; 
            background: #111827; border-top: 1px solid #374151; 
            display: flex; flex-direction: column; z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* SCROLLABLE PILLS */
        .scroll-pills { display: flex; gap: 8px; overflow-x: auto; padding: 0 16px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .scroll-pills::-webkit-scrollbar { display: none; }
        .pill-btn { 
            white-space: nowrap; padding: 8px 16px; border-radius: 99px; font-size: 11px; font-weight: bold; 
            background: #1f2937; color: #9ca3af; border: 1px solid #374151; transition: all 0.2s;
        }
        .pill-btn.active { background: #2563eb; color: white; border-color: #3b82f6; }

        /* OVERLAYS */
        .finish-layer { pointer-events: none; position: absolute; inset: 0; z-index: 10; }
        .staple { position: absolute; width: 24px; height: 5px; background: linear-gradient(90deg, #999, #fff, #999); transform: rotate(-45deg); box-shadow: 1px 1px 3px rgba(0,0,0,0.8); }
        .punch { position: absolute; width: 12px; height: 12px; background: #111; border: 1px solid #666; border-radius: 50%; }

        /* HEADER */
        header { position: absolute; top: 0; left: 0; width: 100%; height: 60px; z-index: 50; padding-top: env(safe-area-inset-top); background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); pointer-events: none; }
        .header-content { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; height: 100%; pointer-events: auto; }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow"><i class="fa-solid fa-print text-white text-xs"></i></div>
                <h1 class="font-bold text-sm tracking-wide text-gray-200">MAGIC<span class="text-blue-500">PRINTER</span></h1>
            </div>
            <button onclick="toggleCart()" class="w-9 h-9 bg-gray-800 rounded-full flex items-center justify-center relative">
                <i class="fa-solid fa-shopping-bag text-gray-400 text-sm"></i>
                <span id="cart-badge" class="absolute -top-1 -right-1 bg-red-500 text-[9px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</span>
            </button>
        </div>
    </header>

    <div id="editor-layer">
        <div id="upload-prompt" class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center">
            <div onclick="document.getElementById('file-input').click()" class="w-64 h-48 border-2 border-dashed border-gray-700 rounded-2xl flex flex-col items-center justify-center bg-gray-900/50 active:scale-95 transition-transform cursor-pointer">
                <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-500 mb-3"></i>
                <span class="font-bold text-gray-300">Tap to Upload</span>
            </div>
            <input type="file" id="file-input" class="hidden" accept=".pdf,.jpg,.jpeg,.png">
        </div>

        <div id="editor-stage" class="hidden w-full h-full">
            <img id="image-target" class="block max-w-full">
            <div id="finish-layer" class="finish-layer"></div>
        </div>
    </div>

    <div id="hud-layer" class="hidden">
        
        <div class="flex justify-between items-center px-4 py-3 border-b border-gray-800">
            <div class="flex gap-4">
                <button onclick="rotate(-90)" class="text-gray-300 hover:text-white flex flex-col items-center gap-1 w-12">
                    <i class="fa-solid fa-rotate-left text-lg"></i>
                    <span class="text-[9px] font-bold uppercase text-gray-500">Rotate</span>
                </button>
                <button onclick="toggleFit()" id="btn-fit" class="text-gray-300 hover:text-white flex flex-col items-center gap-1 w-12">
                    <i class="fa-solid fa-expand text-lg" id="icon-fit"></i>
                    <span class="text-[9px] font-bold uppercase text-gray-500" id="text-fit">Fill</span>
                </button>
            </div>
            
            <div class="h-8 w-px bg-gray-700 mx-2"></div>

            <div class="flex bg-gray-800 rounded-lg p-1">
                <button onclick="setOrient('portrait')" id="t-port" class="px-3 py-1.5 rounded text-[10px] font-bold bg-gray-700 text-white shadow">Port</button>
                <button onclick="setOrient('landscape')" id="t-land" class="px-3 py-1.5 rounded text-[10px] font-bold text-gray-400">Land</button>
            </div>
        </div>

        <div class="py-3">
            <div class="px-4 mb-1 text-[9px] font-bold text-gray-500 uppercase">Paper Size</div>
            <div class="scroll-pills">
                <button onclick="setSize('letter')" id="sz-letter" class="pill-btn active">Letter (8.5x11)</button>
                <button onclick="setSize('legal')" id="sz-legal" class="pill-btn">Legal (8.5x14)</button>
                <button onclick="setSize('tabloid')" id="sz-tabloid" class="pill-btn">Tabloid (11x17)</button>
            </div>
        </div>

        <div class="py-1 pb-2">
            <div class="px-4 mb-1 text-[9px] font-bold text-gray-500 uppercase">Finishing</div>
            <div class="scroll-pills">
                <button onclick="setFinish('none')" id="fn-none" class="pill-btn active">None</button>
                <button onclick="setFinish('staple-tl')" id="fn-staple-tl" class="pill-btn">Staple</button>
                <button onclick="setFinish('punch-3')" id="fn-punch-3" class="pill-btn">Hole Punch</button>
                <button onclick="setFinish('booklet')" id="fn-booklet" class="pill-btn">Booklet</button>
            </div>
        </div>

        <div class="mt-auto p-3 bg-gray-900 border-t border-gray-800 flex gap-3">
            <div class="flex items-center bg-gray-800 rounded-lg px-3">
                <button onclick="qty(-1)" class="text-gray-400 p-2"><i class="fa-solid fa-minus text-xs"></i></button>
                <span id="qty-disp" class="text-sm font-bold text-white w-8 text-center">1</span>
                <button onclick="qty(1)" class="text-gray-400 p-2"><i class="fa-solid fa-plus text-xs"></i></button>
            </div>
            <button onclick="addToCart()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg text-sm flex items-center justify-between px-4">
                <span>Add to Order</span>
                <span id="price-disp">$0.10</span>
            </button>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const DIMS = { letter: {w:8.5, h:11}, legal: {w:8.5, h:14}, tabloid: {w:11, h:17} };
        const PRICES = { letter: 0.10, legal: 0.15, tabloid: 0.25 };
        
        let cropper = null;
        let state = { size: 'letter', orient: 'portrait', finish: 'none', fit: 'cover', qty: 1 };
        
        // --- UPLOAD ---
        document.getElementById('file-input').addEventListener('change', async (e) => {
            if(!e.target.files[0]) return;
            const file = e.target.files[0];
            let src = URL.createObjectURL(file);
            
            // Simple Image Load
            const img = new Image();
            img.onload = () => {
                // Auto-detect Orientation
                state.orient = img.width > img.height ? 'landscape' : 'portrait';
                updateOrientUI();

                // Show Editor
                document.getElementById('upload-prompt').classList.add('hidden');
                document.getElementById('editor-stage').classList.remove('hidden');
                document.getElementById('hud-layer').classList.remove('hidden');
                document.getElementById('image-target').src = src;

                initCropper();
            };
            img.src = src;
        });

        // --- CROPPER ---
        function initCropper() {
            if(cropper) cropper.destroy();
            const el = document.getElementById('image-target');
            const base = DIMS[state.size];
            const ratio = state.orient === 'portrait' ? (base.w / base.h) : (base.h / base.w);

            cropper = new Cropper(el, {
                aspectRatio: ratio,
                viewMode: 0, // Free move
                dragMode: 'move',
                autoCropArea: 1,
                guides: false, center: false, background: false,
                cropBoxMovable: false, cropBoxResizable: false,
                toggleDragModeOnDblclick: false,
                ready() { applyFit(); drawOverlays(); }
            });
        }

        // --- ACTIONS ---
        function rotate(deg) { if(cropper) cropper.rotate(deg); }

        function toggleFit() {
            state.fit = state.fit === 'cover' ? 'contain' : 'cover';
            // Update Icon
            const icon = document.getElementById('icon-fit');
            const text = document.getElementById('text-fit');
            if(state.fit === 'cover') {
                icon.className = 'fa-solid fa-expand text-lg';
                text.innerText = 'Fill';
            } else {
                icon.className = 'fa-solid fa-compress text-lg';
                text.innerText = 'Fit';
            }
            applyFit();
        }

        function applyFit() {
            if(!cropper) return;
            cropper.zoomTo(0);
            const box = cropper.getCropBoxData();
            const canvas = cropper.getCanvasData();
            let z = 0;
            const imgR = canvas.naturalWidth / canvas.naturalHeight;
            const boxR = box.width / box.height;

            if (state.fit === 'cover') z = (imgR > boxR) ? (box.height / canvas.naturalHeight) : (box.width / canvas.naturalWidth);
            else z = (imgR > boxR) ? (box.width / canvas.naturalWidth) : (box.height / canvas.naturalHeight);
            
            cropper.zoomTo(z);
            const newC = cropper.getCanvasData();
            cropper.setCanvasData({ left: box.left+(box.width-newC.width)/2, top: box.top+(box.height-newC.height)/2 });
        }

        function setSize(sz) {
            state.size = sz;
            document.querySelectorAll('[id^="sz-"]').forEach(b => b.classList.remove('active'));
            document.getElementById('sz-'+sz).classList.add('active');
            initCropper(); updatePrice();
        }

        function setOrient(o) {
            state.orient = o;
            updateOrientUI();
            initCropper();
        }

        function updateOrientUI() {
            const p = document.getElementById('t-port');
            const l = document.getElementById('t-land');
            if(state.orient === 'portrait') {
                p.className = 'px-3 py-1.5 rounded text-[10px] font-bold bg-gray-600 text-white shadow transition-all';
                l.className = 'px-3 py-1.5 rounded text-[10px] font-bold text-gray-500 transition-all';
            } else {
                l.className = 'px-3 py-1.5 rounded text-[10px] font-bold bg-gray-600 text-white shadow transition-all';
                p.className = 'px-3 py-1.5 rounded text-[10px] font-bold text-gray-500 transition-all';
            }
        }

        function setFinish(f) {
            state.finish = f;
            document.querySelectorAll('[id^="fn-"]').forEach(b => b.classList.remove('active'));
            document.getElementById('fn-'+f).classList.add('active');
            drawOverlays(); updatePrice();
        }

        function drawOverlays() {
            const l = document.getElementById('finish-layer'); l.innerHTML = '';
            if(!cropper) return;
            const b = cropper.getCropBoxData();
            
            if(state.finish === 'staple-tl') {
                const s = document.createElement('div'); s.className = 'staple';
                s.style.top = (b.top+15)+'px'; s.style.left = (b.left+15)+'px';
                l.appendChild(s);
            }
            if(state.finish === 'punch-3') {
                for(let i=1; i<=3; i++) {
                    const p = document.createElement('div'); p.className = 'punch';
                    p.style.left = (b.left+8)+'px'; p.style.top = (b.top+(b.height*(i/4))-6)+'px';
                    l.appendChild(p);
                }
            }
        }

        function qty(n) {
            state.qty = Math.max(1, state.qty + n);
            document.getElementById('qty-disp').innerText = state.qty;
            updatePrice();
        }

        function updatePrice() {
            const t = (PRICES[state.size] + (state.finish==='none'?0:0.05)) * state.qty;
            document.getElementById('price-disp').innerText = '$' + t.toFixed(2);
        }

        function addToCart() {
            Swal.fire({
                title: 'Added to Order',
                text: `${state.size.toUpperCase()} â€¢ ${state.finish}`,
                icon: 'success',
                toast: true, position: 'top', showConfirmButton: false, timer: 1500
            });
            document.getElementById('cart-badge').classList.remove('hidden');
            document.getElementById('cart-badge').innerText = '1';
        }
        function toggleCart() { alert("Cart Placeholder"); }
    </script>
</body>
</html>
