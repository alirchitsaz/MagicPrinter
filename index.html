<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Printer | Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 950: '#0b0f19', 900: '#111827', 800: '#1f2937', 600: '#2563eb', 500: '#3b82f6' }
                    }
                }
            }
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0b0f19; color: white; -webkit-tap-highlight-color: transparent; }
        
        /* Editor Polish - Paper Simulation */
        .cropper-view-box { outline: 1px solid #999; box-shadow: 0 0 0 9999px rgba(11, 15, 25, 0.85); } /* Dim the outside */
        .cropper-modal { opacity: 0; } /* Remove default dark overlay inside box */
        .cropper-bg { background: #fff; } /* The "Paper" is white */
        
        /* Kyocera Overlays */
        .overlay-layer { pointer-events: none; position: absolute; z-index: 50; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        .safety-zone { border: 1px dashed rgba(220, 38, 38, 0.4); position: absolute; }
        .safety-label { position: absolute; font-size: 9px; color: rgba(220, 38, 38, 0.6); font-weight: bold; top: 2px; right: 2px; text-transform: uppercase; }
        .staple { position: absolute; background: linear-gradient(90deg, #9ca3af, #f3f4f6, #9ca3af); box-shadow: 1px 1px 3px rgba(0,0,0,0.4); z-index: 60; }
        .punch { position: absolute; background: #0b0f19; border: 1px solid #333; border-radius: 50%; z-index: 60; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden">

    <header class="h-14 bg-brand-900 border-b border-gray-800 flex items-center justify-between px-4 shrink-0 z-50">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-brand-600 rounded flex items-center justify-center shadow-lg"><i class="fa-solid fa-wand-magic-sparkles text-white text-xs"></i></div>
            <div class="leading-none">
                <h1 class="font-bold tracking-tight text-sm">MAGIC<span class="text-brand-500">PRINTER</span></h1>
                <span class="text-[9px] text-gray-500 uppercase tracking-widest font-bold">Studio</span>
            </div>
        </div>
        <button onclick="toggleCart()" class="relative p-2">
            <i class="fa-solid fa-print text-gray-400"></i>
            <span id="cart-badge" class="absolute top-0 right-0 bg-brand-500 text-[9px] w-4 h-4 rounded-full flex items-center justify-center hidden border border-brand-900">0</span>
        </button>
    </header>

    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">

        <div class="flex-1 bg-[#0b0f19] relative flex flex-col z-0">
            
            <div id="editor-toolbar" class="h-12 bg-brand-900/90 border-b border-gray-800 flex items-center justify-center gap-4 px-2 hidden z-40 backdrop-blur-sm">
                <button onclick="rotateImage(-90)" class="text-gray-400 hover:text-white px-2"><i class="fa-solid fa-arrow-rotate-left"></i></button>
                
                <div class="w-px h-4 bg-gray-700"></div>
                
                <button onclick="smartFit('cover')" id="btn-cover" class="px-3 py-1 rounded bg-brand-800 text-[10px] font-bold uppercase text-white hover:bg-brand-700 transition-colors border border-brand-500">
                    Fill Page
                </button>
                <button onclick="smartFit('contain')" id="btn-contain" class="px-3 py-1 rounded bg-brand-950 text-[10px] font-bold uppercase text-gray-400 hover:text-white transition-colors border border-gray-700">
                    Fit Inside
                </button>
                
                <div class="w-px h-4 bg-gray-700"></div>

                <button onclick="zoom(0.1)" class="text-gray-400 hover:text-white"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
                <button onclick="zoom(-0.1)" class="text-gray-400 hover:text-white"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
            </div>

            <div class="flex-1 relative overflow-hidden flex items-center justify-center bg-[#0b0f19]">
                
                <div id="upload-state" class="text-center w-full max-w-sm p-4">
                    <div onclick="document.getElementById('file-input').click()" class="aspect-video border-2 border-dashed border-gray-700 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-brand-500 hover:bg-brand-900/20 transition-all group">
                        <div class="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-cloud-arrow-up text-2xl text-gray-400 group-hover:text-brand-400"></i>
                        </div>
                        <h3 class="font-bold text-gray-200">New Project</h3>
                        <p class="text-xs text-gray-500 mt-2">Tap to Upload</p>
                    </div>
                    <input type="file" id="file-input" class="hidden" accept=".pdf,.jpg,.jpeg,.png">
                </div>

                <div id="editor-container" class="hidden w-full h-full relative">
                    <img id="image-target" src="" class="block max-w-full">
                    <div id="overlay-layer" class="overlay-layer hidden"></div>
                </div>
            </div>
        </div>

        <div class="h-[45vh] lg:h-auto lg:w-[350px] bg-brand-900 border-t lg:border-t-0 lg:border-l border-gray-800 flex flex-col z-50 shadow-2xl">
            
            <div class="flex-1 overflow-y-auto p-5 space-y-6">
                
                <div class="bg-brand-950 p-1 rounded-lg border border-gray-800 flex">
                    <button onclick="setOrient('portrait')" id="t-port" class="flex-1 py-2 rounded text-xs font-bold bg-brand-800 text-white shadow"><i class="fa-regular fa-file mr-2"></i>Portrait</button>
                    <button onclick="setOrient('landscape')" id="t-land" class="flex-1 py-2 rounded text-xs font-bold text-gray-400 hover:text-white"><i class="fa-regular fa-file fa-rotate-90 mr-2"></i>Landscape</button>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Paper Size</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setPaper('letter')" id="p-letter" class="p-btn active p-2 rounded border border-brand-500 bg-brand-800 text-center">
                            <div class="text-xs font-bold text-white">Letter</div>
                            <div class="text-[9px] text-gray-400">8.5x11</div>
                        </button>
                        <button onclick="setPaper('legal')" id="p-legal" class="p-btn p-2 rounded border border-gray-700 bg-brand-950 text-center">
                            <div class="text-xs font-bold text-gray-400">Legal</div>
                            <div class="text-[9px] text-gray-500">8.5x14</div>
                        </button>
                        <button onclick="setPaper('tabloid')" id="p-tabloid" class="p-btn p-2 rounded border border-gray-700 bg-brand-950 text-center">
                            <div class="text-xs font-bold text-gray-400">Tabloid</div>
                            <div class="text-[9px] text-gray-500">11x17</div>
                        </button>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Finishing</label>
                    <select id="finish-opt" onchange="updateFinish()" class="w-full bg-brand-950 border border-gray-700 rounded-lg h-10 px-3 text-sm text-gray-200 outline-none focus:border-brand-500">
                        <option value="none">None</option>
                        <option value="staple-tl">Staple: Top Left</option>
                        <option value="punch-3">3-Hole Punch</option>
                        <option value="booklet">Booklet Fold</option>
                    </select>
                </div>

                <div class="flex items-center justify-between border-t border-gray-800 pt-4 mt-2">
                    <span class="text-xs font-bold text-gray-400 uppercase">Copies</span>
                    <div class="flex items-center gap-3">
                        <button onclick="adjQty(-1)" class="w-8 h-8 rounded bg-brand-800 text-white hover:bg-brand-700">-</button>
                        <span id="qty-disp" class="font-bold w-6 text-center">1</span>
                        <button onclick="adjQty(1)" class="w-8 h-8 rounded bg-brand-800 text-white hover:bg-brand-700">+</button>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-800 bg-brand-900 pb-safe">
                <button onclick="addToCart()" id="btn-add" disabled class="w-full h-12 bg-white text-brand-900 font-bold rounded-xl shadow-lg flex items-center justify-between px-6 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-transform">
                    <span>Add to Order</span>
                    <span id="price-disp">$0.10</span>
                </button>
            </div>
        </div>
    </main>

    <div id="cart-drawer" class="fixed right-0 top-0 h-full w-full max-w-sm bg-brand-900 shadow-2xl z-[70] transform translate-x-full transition-transform duration-300 flex flex-col border-l border-gray-800">
        <div class="p-5 border-b border-gray-800 flex justify-between items-center bg-brand-950">
            <h2 class="font-bold text-lg">Order Summary</h2>
            <button onclick="toggleCart()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="cart-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
        <div class="p-5 border-t border-gray-800 bg-brand-950 mb-safe">
            <button onclick="checkout()" class="w-full h-14 bg-brand-600 rounded-xl font-bold text-white shadow-lg">Submit Order</button>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const DIMS = { letter: {w:8.5, h:11}, legal: {w:8.5, h:14}, tabloid: {w:11, h:17} };
        const PRICES = { letter: 0.10, legal: 0.15, tabloid: 0.25 };
        
        // --- STATE ---
        let cropper = null;
        let state = { size: 'letter', orient: 'portrait', finish: 'none', qty: 1 };
        let cart = [];

        // --- UPLOAD ---
        const fileInput = document.getElementById('file-input');
        fileInput.addEventListener('change', (e) => { if(e.target.files[0]) processFile(e.target.files[0]); });

        async function processFile(file) {
            let src = '';
            // PDF vs Image
            if(file.type.includes('pdf')) {
                const buff = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buff).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 2 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width; canvas.height = viewport.height;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                src = canvas.toDataURL('image/jpeg');
            } else {
                src = URL.createObjectURL(file);
            }

            // Auto-Detect Orientation
            const img = new Image();
            img.onload = () => {
                state.orient = img.width > img.height ? 'landscape' : 'portrait';
                updateOrientUI();
                
                // Init Editor
                document.getElementById('image-target').src = src;
                document.getElementById('upload-state').classList.add('hidden');
                document.getElementById('editor-container').classList.remove('hidden');
                document.getElementById('editor-toolbar').classList.remove('hidden');
                document.getElementById('btn-add').disabled = false;
                
                initCropper();
            };
            img.src = src;
        }

        // --- CORE CROPPER LOGIC ---
        function initCropper() {
            if(cropper) cropper.destroy();
            const el = document.getElementById('image-target');
            
            // Calculate Aspect Ratio
            const base = DIMS[state.size];
            const ratio = state.orient === 'portrait' ? (base.w / base.h) : (base.h / base.w);

            cropper = new Cropper(el, {
                aspectRatio: ratio,
                viewMode: 0, // 0 = Free Move (Allows whitespace/borders)
                dragMode: 'move',
                autoCropArea: 1,
                guides: false,
                center: false,
                background: false, // Handled by CSS
                cropBoxMovable: false, // The paper stays still
                cropBoxResizable: false, // The paper stays fixed size
                toggleDragModeOnDblclick: false,
                ready() {
                    smartFit('cover'); // Default to fill
                    drawOverlays();
                },
                crop: drawOverlays
            });
        }

        function smartFit(mode) {
            if(!cropper) return;
            
            // Visual Button Toggle
            const btnCover = document.getElementById('btn-cover');
            const btnContain = document.getElementById('btn-contain');
            
            if(mode === 'cover') {
                btnCover.className = 'px-3 py-1 rounded bg-brand-800 text-[10px] font-bold uppercase text-white border border-brand-500';
                btnContain.className = 'px-3 py-1 rounded bg-brand-950 text-[10px] font-bold uppercase text-gray-400 hover:text-white border border-gray-700';
            } else {
                btnContain.className = 'px-3 py-1 rounded bg-brand-800 text-[10px] font-bold uppercase text-white border border-brand-500';
                btnCover.className = 'px-3 py-1 rounded bg-brand-950 text-[10px] font-bold uppercase text-gray-400 hover:text-white border border-gray-700';
            }

            // --- THE MATH ---
            const containerData = cropper.getContainerData(); // Viewport size
            const canvasData = cropper.getCanvasData(); // Image size
            const boxData = cropper.getCropBoxData(); // Paper size
            
            const imgAspect = canvasData.naturalWidth / canvasData.naturalHeight;
            const paperAspect = boxData.width / boxData.height;
            
            // Reset to 0 zoom to start calculation clean
            cropper.zoomTo(0); // This sets it to fit view, not 0 size
            
            // Re-get data after reset
            const newCanvas = cropper.getCanvasData();
            
            if (mode === 'cover') {
                // FILL PAGE: Zoom until smallest dimension matches box
                if (imgAspect > paperAspect) {
                    // Image is wider than paper -> Fit Height
                    const zoomRatio = boxData.height / newCanvas.naturalHeight;
                    cropper.zoomTo(zoomRatio);
                } else {
                    // Image is taller than paper -> Fit Width
                    const zoomRatio = boxData.width / newCanvas.naturalWidth;
                    cropper.zoomTo(zoomRatio);
                }
            } else {
                // FIT INSIDE: Zoom until largest dimension fits in box
                if (imgAspect > paperAspect) {
                     // Image is wider -> Fit Width
                     const zoomRatio = boxData.width / newCanvas.naturalWidth;
                     cropper.zoomTo(zoomRatio);
                } else {
                    // Image is taller -> Fit Height
                    const zoomRatio = boxData.height / newCanvas.naturalHeight;
                    cropper.zoomTo(zoomRatio);
                }
            }
            
            // Center the image in the box
            const finalCanvas = cropper.getCanvasData();
            const centerX = boxData.left + (boxData.width/2) - (finalCanvas.width/2);
            const centerY = boxData.top + (boxData.height/2) - (finalCanvas.height/2);
            
            cropper.setCanvasData({ left: centerX, top: centerY, width: finalCanvas.width, height: finalCanvas.height });
        }

        function zoom(ratio) { cropper.zoom(ratio); }
        function rotateImage(deg) { cropper.rotate(deg); }

        // --- OVERLAYS ---
        function drawOverlays() {
            const layer = document.getElementById('overlay-layer');
            layer.classList.remove('hidden');
            layer.innerHTML = '';
            if(!cropper) return;
            
            const data = cropper.getCropBoxData();
            const { width, height, top, left } = data;

            // Safety Zone (Red Dashed)
            const safe = document.createElement('div');
            safe.className = 'safety-zone';
            safe.style.left = (left + 10) + 'px';
            safe.style.top = (top + 10) + 'px';
            safe.style.width = (width - 20) + 'px';
            safe.style.height = (height - 20) + 'px';
            safe.innerHTML = '<span class="safety-label">Safe Zone</span>';
            layer.appendChild(safe);

            // Finishing
            const finish = document.getElementById('finish-opt').value;
            if(finish.includes('staple')) {
                const s = document.createElement('div');
                s.className = 'staple';
                s.style.width = '25px'; s.style.height = '5px';
                s.style.top = (top + 12) + 'px';
                s.style.left = (left + 12) + 'px';
                s.style.transform = 'rotate(-45deg)';
                layer.appendChild(s);
            }
            if(finish.includes('punch')) {
                for(let i=1; i<=3; i++) {
                    const p = document.createElement('div');
                    p.className = 'punch';
                    p.style.width = '10px'; p.style.height = '10px';
                    p.style.left = (left + 6) + 'px';
                    p.style.top = (top + (height * (i/4))) + 'px';
                    layer.appendChild(p);
                }
            }
        }

        // --- UI UPDATES ---
        function setOrient(o) {
            state.orient = o;
            updateOrientUI();
            initCropper();
        }
        function updateOrientUI() {
            const p = document.getElementById('t-port');
            const l = document.getElementById('t-land');
            if(state.orient === 'portrait') {
                p.className = 'flex-1 py-2 rounded text-xs font-bold bg-brand-800 text-white shadow ring-1 ring-brand-500';
                l.className = 'flex-1 py-2 rounded text-xs font-bold text-gray-400 hover:text-white';
            } else {
                l.className = 'flex-1 py-2 rounded text-xs font-bold bg-brand-800 text-white shadow ring-1 ring-brand-500';
                p.className = 'flex-1 py-2 rounded text-xs font-bold text-gray-400 hover:text-white';
            }
        }
        function setPaper(sz) {
            state.size = sz;
            document.querySelectorAll('.p-btn').forEach(b => {
                b.className = 'p-btn p-2 rounded border border-gray-700 bg-brand-950 text-center';
                b.querySelector('div:first-child').className = 'text-xs font-bold text-gray-400';
            });
            const active = document.getElementById('p-'+sz);
            active.className = 'p-btn active p-2 rounded border border-brand-500 bg-brand-800 text-center';
            active.querySelector('div:first-child').className = 'text-xs font-bold text-white';
            initCropper();
            updatePrice();
        }
        function adjQty(n) {
            state.qty = Math.max(1, state.qty + n);
            document.getElementById('qty-disp').innerText = state.qty;
            updatePrice();
        }
        function updateFinish() {
            state.finish = document.getElementById('finish-opt').value;
            drawOverlays();
            updatePrice();
        }
        function updatePrice() {
            const total = (PRICES[state.size] + (state.finish==='none'?0:0.05)) * state.qty;
            document.getElementById('price-disp').innerText = '$' + total.toFixed(2);
        }

        // --- CART ---
        function addToCart() {
            cart.push({...state, total: document.getElementById('price-disp').innerText});
            updateCart();
            toggleCart();
        }
        function updateCart() {
            document.getElementById('cart-badge').innerText = cart.length;
            document.getElementById('cart-badge').classList.remove('hidden');
            document.getElementById('cart-list').innerHTML = cart.map(c => `
                <div class="bg-brand-800 p-3 rounded flex justify-between">
                    <div class="text-sm">
                        <span class="font-bold text-white">${c.size.toUpperCase()}</span>
                        <span class="text-xs text-gray-400 block">${c.orient} â€¢ ${c.finish}</span>
                    </div>
                    <span class="font-bold text-brand-400">${c.total}</span>
                </div>
            `).join('');
        }
        function toggleCart() {
            document.getElementById('cart-drawer').classList.toggle('translate-x-full');
        }
        function checkout() {
            Swal.fire({ title: 'Submitted', icon: 'success', confirmButtonColor: '#2563eb' });
            cart = []; updateCart(); toggleCart();
        }
    </script>
</body>
</html>
