<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Magic Printer | Gesture UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 950: '#0b0f19', 900: '#111827', 800: '#1f2937', 600: '#2563eb', 500: '#3b82f6' }
                    },
                    spacing: { 'safe-t': 'env(safe-area-inset-top)', 'safe-b': 'env(safe-area-inset-bottom)' }
                }
            }
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        /* 1. APP SHELL */
        html, body { height: 100%; width: 100%; overflow: hidden; position: fixed; background: #000; font-family: 'Inter', sans-serif; color: white; }
        
        /* 2. BACKGROUND LAYER (The Image) */
        #editor-layer { position: absolute; inset: 0; z-index: 0; background: #111; }
        .cropper-view-box { outline: 1px solid rgba(255,255,255,0.5); box-shadow: 0 0 0 9999px rgba(0,0,0,0.85); } 
        .cropper-bg { background: #fff; } /* White Paper */

        /* 3. BOTTOM SHEET (Gesture Controlled) */
        #bottom-sheet {
            position: absolute; left: 0; right: 0; bottom: 0;
            height: 85vh; /* Max height */
            background: #1f2937;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
            z-index: 50;
            touch-action: none; /* Crucial for custom drag */
            transform: translateY(calc(100% - 100px)); /* Default Collapsed State */
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        /* When dragging, disable transition for 1:1 movement */
        #bottom-sheet.dragging { transition: none; }

        /* The Grab Handle Area */
        .sheet-header { padding: 12px 0 0 0; cursor: grab; background: #1f2937; border-top-left-radius: 24px; border-top-right-radius: 24px; }
        .sheet-handle { width: 48px; height: 5px; background: #4b5563; border-radius: 10px; margin: 0 auto 12px auto; }
        
        .sheet-content { height: 100%; overflow-y: auto; padding: 0 20px 120px 20px; -webkit-overflow-scrolling: touch; }

        /* 4. OVERLAYS */
        .finish-layer { pointer-events: none; position: absolute; inset: 0; z-index: 10; }
        .staple { position: absolute; width: 24px; height: 5px; background: linear-gradient(90deg, #999, #fff, #999); transform: rotate(-45deg); box-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .punch { position: absolute; width: 12px; height: 12px; background: #111; border: 1px solid #444; border-radius: 50%; }
    </style>
</head>
<body>

    <header class="absolute top-0 left-0 w-full h-16 flex items-center justify-between px-4 pt-safe-t z-50 pointer-events-none">
        <button onclick="toggleProfile()" class="pointer-events-auto w-10 h-10 bg-black/40 backdrop-blur rounded-full flex items-center justify-center border border-white/10 text-white">
            <i class="fa-solid fa-user"></i>
        </button>
        <button onclick="toggleCart()" class="pointer-events-auto w-10 h-10 bg-black/40 backdrop-blur rounded-full flex items-center justify-center border border-white/10 text-white relative">
            <i class="fa-solid fa-shopping-bag"></i>
            <span id="cart-badge" class="absolute -top-1 -right-1 bg-blue-600 text-[10px] w-5 h-5 rounded-full flex items-center justify-center hidden">0</span>
        </button>
    </header>

    <div id="editor-layer">
        <div id="upload-prompt" class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center">
            <div onclick="document.getElementById('file-input').click()" class="w-64 h-64 border-2 border-dashed border-gray-700 rounded-3xl flex flex-col items-center justify-center bg-gray-900/50 active:scale-95 transition-transform cursor-pointer">
                <i class="fa-solid fa-plus text-4xl text-gray-500 mb-4"></i>
                <span class="font-bold text-lg text-gray-300">New Project</span>
                <span class="text-sm text-gray-500 mt-1">Tap to Upload</span>
            </div>
            <input type="file" id="file-input" class="hidden" accept=".pdf,.jpg,.jpeg,.png">
        </div>

        <div id="editor-stage" class="hidden w-full h-full">
            <img id="image-target" class="block max-w-full">
            <div id="finish-layer" class="finish-layer"></div>
        </div>
    </div>

    <div id="bottom-sheet">
        <div class="sheet-header" id="sheet-drag-zone">
            <div class="sheet-handle"></div>
            <div class="flex justify-between items-center px-6 pb-4">
                <div>
                    <h3 class="font-bold text-white text-base">Print Options</h3>
                    <p class="text-xs text-brand-500 font-mono mt-0.5" id="summary-text">Letter • Portrait</p>
                </div>
                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-gray-400">
                    <i class="fa-solid fa-chevron-up text-xs"></i>
                </div>
            </div>
        </div>

        <div class="sheet-content">
            
            <div class="grid grid-cols-3 gap-3 mb-6">
                <button onclick="rotate(-90)" class="bg-gray-800 py-3 rounded-xl text-gray-300 text-xs font-bold flex flex-col items-center gap-1 active:bg-gray-700"><i class="fa-solid fa-rotate-left text-sm"></i>Rotate</button>
                <button onclick="fit('cover')" class="bg-gray-800 py-3 rounded-xl text-gray-300 text-xs font-bold flex flex-col items-center gap-1 active:bg-gray-700"><i class="fa-solid fa-maximize text-sm"></i>Fill</button>
                <button onclick="fit('contain')" class="bg-gray-800 py-3 rounded-xl text-gray-300 text-xs font-bold flex flex-col items-center gap-1 active:bg-gray-700"><i class="fa-solid fa-compress text-sm"></i>Fit</button>
            </div>

            <div class="space-y-3 mb-6">
                <label class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Paper Size</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="setSize('letter')" id="btn-letter" class="p-3 rounded-xl border border-blue-500 bg-blue-600/20 text-xs font-bold text-white transition-all">Letter</button>
                    <button onclick="setSize('legal')" id="btn-legal" class="p-3 rounded-xl border border-gray-700 bg-gray-800 text-xs font-bold text-gray-400 transition-all">Legal</button>
                    <button onclick="setSize('tabloid')" id="btn-tabloid" class="p-3 rounded-xl border border-gray-700 bg-gray-800 text-xs font-bold text-gray-400 transition-all">Tabloid</button>
                </div>
            </div>

            <div class="space-y-3 mb-8">
                <label class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Finishing</label>
                <div class="relative">
                    <select id="finish-opt" onchange="updateFinish()" class="w-full bg-gray-800 border border-gray-700 rounded-xl h-14 px-4 text-sm text-white appearance-none outline-none font-medium">
                        <option value="none">None</option>
                        <option value="staple-tl">Staple: Top-Left</option>
                        <option value="punch-3">Hole Punch: 3-Hole</option>
                    </select>
                    <div class="absolute right-4 top-4 text-gray-400 pointer-events-none"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
            </div>

            <div class="bg-gray-800 rounded-2xl p-4 border border-gray-700 flex items-center justify-between mb-4">
                <button onclick="adjQty(-1)" class="w-10 h-10 rounded-lg bg-gray-700 text-white flex items-center justify-center active:bg-gray-600"><i class="fa-solid fa-minus"></i></button>
                <span class="font-bold text-lg" id="qty-disp">1 Copy</span>
                <button onclick="adjQty(1)" class="w-10 h-10 rounded-lg bg-gray-700 text-white flex items-center justify-center active:bg-gray-600"><i class="fa-solid fa-plus"></i></button>
            </div>
            
            <button onclick="addToCart()" id="btn-add" disabled class="w-full h-14 bg-white text-black font-bold text-lg rounded-2xl shadow-lg flex items-center justify-between px-6 active:scale-95 transition-all disabled:opacity-50 disabled:grayscale">
                <span>Add to Order</span>
                <span id="price-disp">$0.10</span>
            </button>
        </div>
    </div>

    <div id="profile-drawer" class="fixed inset-y-0 left-0 w-80 bg-gray-900 shadow-2xl transform -translate-x-full transition-transform duration-300 z-[60] border-r border-gray-800 flex flex-col">
        <div class="p-6 pt-safe-t bg-gray-950 border-b border-gray-800">
            <h2 class="text-xl font-bold text-white" id="profile-name">Guest</h2>
            <p class="text-xs text-gray-500 mt-1">Kyocera Direct Print</p>
        </div>
        <div class="p-4 space-y-2 flex-1">
            <div class="p-3 rounded-lg hover:bg-gray-800 cursor-pointer text-sm text-gray-300 flex gap-3 items-center"><i class="fa-solid fa-clock-rotate-left w-5"></i> History</div>
            <div class="p-3 rounded-lg hover:bg-gray-800 cursor-pointer text-sm text-gray-300 flex gap-3 items-center"><i class="fa-solid fa-credit-card w-5"></i> Billing</div>
        </div>
        <div class="p-4 border-t border-gray-800 pb-safe-b">
            <button onclick="toggleProfile()" class="w-full py-3 text-center text-sm text-gray-400 font-bold hover:text-white">Close Menu</button>
        </div>
    </div>

    <script>
        // --- GESTURE ENGINE (The Magic Part) ---
        const sheet = document.getElementById('bottom-sheet');
        const handle = document.getElementById('sheet-drag-zone');
        let startY = 0;
        let currentY = 0;
        let isDragging = false;
        
        // Define Snap Points (pixels from top of screen)
        const SNAP_OPEN = window.innerHeight * 0.15; // 15% from top
        const SNAP_CLOSED = window.innerHeight - 100; // 100px visible at bottom

        handle.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
            // Get current transform value (roughly) or assume state
            sheet.classList.add('dragging');
            isDragging = true;
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const y = e.touches[0].clientY;
            const delta = y - startY;
            
            // Calculate new position based on previous state
            // Simplified logic: Just track the drag relative to screen
            // In a real app we'd track current Offset, but for this demo:
            
            // Just move it with finger
            // Note: This logic assumes we started from a snap point. 
            // For robustness in this single-file demo, we will use a simpler CSS class toggle on end,
            // but while dragging, we can translate.
            
            // Let's rely on simple swipe detection for v10 efficiency
        }, { passive: true });

        handle.addEventListener('touchend', (e) => {
            sheet.classList.remove('dragging');
            isDragging = false;
            const endY = e.changedTouches[0].clientY;
            const dist = endY - startY;

            // If dragged UP significantly, Open
            if (dist < -50) {
                openSheet();
            } 
            // If dragged DOWN significantly, Close
            else if (dist > 50) {
                closeSheet();
            }
            // Tap detection (minimal movement)
            else if (Math.abs(dist) < 10) {
                toggleSheet();
            }
        });

        function openSheet() {
            sheet.style.transform = `translateY(0)`; // Shows full height (85vh)
        }
        function closeSheet() {
            sheet.style.transform = `translateY(calc(100% - 110px))`; // Shows just header
        }
        function toggleSheet() {
            const current = sheet.style.transform;
            if (current.includes('0') && !current.includes('100%')) closeSheet();
            else openSheet();
        }

        // --- STANDARD LOGIC ---
        const PRICES = { letter: 0.10, legal: 0.15, tabloid: 0.25 };
        const DIMS = { letter: {w:8.5, h:11}, legal: {w:8.5, h:14}, tabloid: {w:11, h:17} };
        let cropper = null;
        let state = { size: 'letter', orient: 'portrait', finish: 'none', qty: 1 };
        let user = JSON.parse(localStorage.getItem('mp_user')) || { name: 'Ali Chitsaz' };

        document.getElementById('profile-name').innerText = user.name;

        // Init
        closeSheet(); // Start closed

        document.getElementById('file-input').addEventListener('change', async (e) => {
            if(!e.target.files[0]) return;
            const file = e.target.files[0];
            let src = URL.createObjectURL(file);

            const img = new Image();
            img.onload = () => {
                state.orient = img.width > img.height ? 'landscape' : 'portrait';
                document.getElementById('upload-prompt').classList.add('hidden');
                document.getElementById('editor-stage').classList.remove('hidden');
                document.getElementById('image-target').src = src;
                document.getElementById('btn-add').disabled = false;
                
                // Show user the options, then they can drag down
                openSheet();
                initCropper();
            };
            img.src = src;
        });

        function initCropper() {
            if(cropper) cropper.destroy();
            const el = document.getElementById('image-target');
            const base = DIMS[state.size];
            const ratio = state.orient === 'portrait' ? (base.w / base.h) : (base.h / base.w);

            cropper = new Cropper(el, {
                aspectRatio: ratio,
                viewMode: 0, dragMode: 'move', autoCropArea: 1,
                guides: false, center: false, background: false,
                cropBoxMovable: false, cropBoxResizable: false,
                ready() { fit('cover'); drawOverlays(); updateSummary(); }
            });
        }

        function fit(mode) {
            if(!cropper) return;
            cropper.zoomTo(0);
            const box = cropper.getCropBoxData();
            const canvas = cropper.getCanvasData();
            const z = mode === 'cover' 
                ? Math.max(box.width/canvas.naturalWidth, box.height/canvas.naturalHeight)
                : Math.min(box.width/canvas.naturalWidth, box.height/canvas.naturalHeight);
            cropper.zoomTo(z);
            const newC = cropper.getCanvasData();
            cropper.setCanvasData({ left: box.left+(box.width-newC.width)/2, top: box.top+(box.height-newC.height)/2 });
        }

        function setSize(sz) {
            state.size = sz;
            document.querySelectorAll('#btn-letter, #btn-legal, #btn-tabloid').forEach(b => {
                b.className = 'p-3 rounded-xl border border-gray-700 bg-gray-800 text-xs font-bold text-gray-400 transition-all';
            });
            document.getElementById('btn-'+sz).className = 'p-3 rounded-xl border border-blue-500 bg-blue-600/20 text-xs font-bold text-white transition-all';
            initCropper(); updatePrice();
        }

        function updateFinish() {
            state.finish = document.getElementById('finish-opt').value;
            drawOverlays(); updateSummary(); updatePrice();
        }

        function drawOverlays() {
            const l = document.getElementById('finish-layer'); l.innerHTML = '';
            if(!cropper) return;
            const b = cropper.getCropBoxData();
            if(state.finish === 'staple-tl') {
                const s = document.createElement('div'); s.className = 'staple';
                s.style.top = (b.top+15)+'px'; s.style.left = (b.left+15)+'px';
                l.appendChild(s);
            }
            if(state.finish === 'punch-3') {
                for(let i=1; i<=3; i++) {
                    const p = document.createElement('div'); p.className = 'punch';
                    p.style.left = (b.left+8)+'px'; p.style.top = (b.top+(b.height*(i/4))-6)+'px';
                    l.appendChild(p);
                }
            }
        }

        function updateSummary() {
            document.getElementById('summary-text').innerText = `${state.size.toUpperCase()} • ${state.orient.toUpperCase()}`;
        }
        function rotate(d) { if(cropper) cropper.rotate(d); }
        function adjQty(n) { state.qty = Math.max(1, state.qty+n); document.getElementById('qty-disp').innerText = state.qty + ' Copy'; updatePrice(); }
        function updatePrice() { document.getElementById('price-disp').innerText = '$' + ((PRICES[state.size]+(state.finish==='none'?0:0.05))*state.qty).toFixed(2); }
        
        function addToCart() {
            Swal.fire({icon: 'success', title: 'Added', timer: 1000, showConfirmButton: false});
            closeSheet();
            document.getElementById('cart-badge').classList.remove('hidden');
            document.getElementById('cart-badge').innerText = '1';
        }

        function toggleProfile() { document.getElementById('profile-drawer').classList.toggle('-translate-x-full'); }
        function toggleCart() { alert("Cart View Placeholder"); }
    </script>
</body>
</html>
