<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Printer | v18 Safe</title>
    
    <style>
        body { background: #000; color: #fff; font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 0; padding-bottom: 100px; }
        #crash-report { display: none; background: #900; color: #fff; padding: 20px; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; }
        
        /* Upload Box */
        .upload-box { 
            border: 2px dashed #444; border-radius: 12px; padding: 40px 20px; text-align: center; 
            background: #111; cursor: pointer; margin-bottom: 24px;
        }
        .upload-text { font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #eee; }
        .upload-sub { font-size: 14px; color: #888; }

        /* Editor */
        .editor-wrap { display: none; margin-bottom: 24px; }
        .img-container { width: 100%; background: #222; min-height: 200px; }
        img { max-width: 100%; display: block; }

        /* Controls */
        .control-group { margin-bottom: 24px; }
        .label { font-size: 12px; font-weight: bold; color: #888; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .btn-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; }
        .btn { 
            flex: 1; padding: 12px; background: #222; border: 1px solid #444; border-radius: 8px; 
            color: #ccc; font-size: 14px; font-weight: 600; white-space: nowrap; min-width: 80px; text-align: center;
        }
        .btn.active { background: #2563eb; color: #fff; border-color: #2563eb; }

        /* Footer */
        .footer { 
            position: fixed; bottom: 0; left: 0; width: 100%; background: #111; 
            border-top: 1px solid #333; padding: 16px; display: flex; gap: 12px;
        }
        .qty-btn { width: 48px; background: #222; color: #fff; border: 1px solid #444; border-radius: 8px; font-size: 18px; }
        .qty-disp { width: 40px; text-align: center; line-height: 48px; font-weight: bold; }
        .add-btn { flex: 1; background: #2563eb; color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; }
        .add-btn:disabled { background: #444; color: #888; }
    </style>

    <script>
        window.onerror = function(msg, url, line) {
            document.getElementById('crash-report').style.display = 'block';
            document.getElementById('crash-msg').innerText = msg + " (Line " + line + ")";
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
</head>
<body>

    <div id="crash-report">
        <strong>System Error:</strong> <span id="crash-msg">Unknown</span>
        <br><br>Please refresh the page.
    </div>

    <div class="flex items-center justify-between px-4 py-3 bg-gray-900 border-b border-gray-800">
        <div class="font-bold text-lg">MAGIC<span class="text-blue-500">PRINTER</span></div>
        <div class="text-xs text-gray-500 font-mono">v18.0</div>
    </div>

    <div class="container">
        
        <div id="upload-section" class="upload-box" onclick="document.getElementById('file-input').click()">
            <div class="upload-text">Tap to Upload</div>
            <div class="upload-sub">PDF, JPG, PNG</div>
            <input type="file" id="file-input" style="display:none" accept=".pdf,.jpg,.jpeg,.png">
        </div>

        <div id="editor-section" class="editor-wrap">
            <div class="control-group">
                <span class="label">Preview</span>
                <div class="img-container">
                    <img id="image-target" src="">
                </div>
            </div>

            <div class="btn-row mb-6">
                <button onclick="rotate(-90)" class="btn">Rotate</button>
                <button onclick="fit('cover')" class="btn">Fill Page</button>
                <button onclick="fit('contain')" class="btn">Fit Inside</button>
            </div>

            <div class="control-group">
                <span class="label">Paper Size</span>
                <div class="btn-row">
                    <button onclick="setSize('letter')" id="sz-letter" class="btn active">Letter</button>
                    <button onclick="setSize('legal')" id="sz-legal" class="btn">Legal</button>
                    <button onclick="setSize('tabloid')" id="sz-tabloid" class="btn">Tabloid</button>
                </div>
            </div>

            <div class="control-group">
                <span class="label">Finishing</span>
                <div class="btn-row">
                    <button onclick="setFinish('none')" id="fn-none" class="btn active">None</button>
                    <button onclick="setFinish('staple')" id="fn-staple" class="btn">Staple</button>
                    <button onclick="setFinish('punch')" id="fn-punch" class="btn">Hole Punch</button>
                    <button onclick="setFinish('booklet')" id="fn-booklet" class="btn">Booklet</button>
                </div>
            </div>
        </div>

    </div>

    <div class="footer">
        <button class="qty-btn" onclick="qty(-1)">-</button>
        <div class="qty-disp" id="qty-disp">1</div>
        <button class="qty-btn" onclick="qty(1)">+</button>
        <button class="add-btn" id="btn-add" disabled onclick="submitOrder()">
            Add to Order (<span id="price">$0.10</span>)
        </button>
    </div>

    <script>
        // PDF WORKER SETUP (Wrapped in Try/Catch)
        try {
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
        } catch (e) {
            console.warn("PDF Engine Warning:", e);
        }

        // STATE
        let cropper = null;
        let state = { size: 'letter', finish: 'none', qty: 1 };
        const PRICES = { letter: 0.10, legal: 0.15, tabloid: 0.25 };
        const DIMS = { letter: 8.5/11, legal: 8.5/14, tabloid: 11/17 };

        // 1. FILE UPLOAD
        document.getElementById('file-input').addEventListener('change', async function(e) {
            if (!e.target.files[0]) return;
            const file = e.target.files[0];
            let src = '';

            try {
                // PDF Handler
                if (file.type === 'application/pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 1.5 });
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width; 
                    canvas.height = viewport.height;
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                    src = canvas.toDataURL('image/jpeg');
                } else {
                    // Image Handler
                    src = URL.createObjectURL(file);
                }

                // Load Editor
                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('editor-section').style.display = 'block';
                document.getElementById('btn-add').disabled = false;
                
                const img = document.getElementById('image-target');
                img.src = src;
                
                // Initialize Cropper (Delayed to ensure DOM is ready)
                setTimeout(() => initCropper(), 100);

            } catch (err) {
                alert("Error loading file: " + err.message);
            }
        });

        function initCropper() {
            if(cropper) cropper.destroy();
            const img = document.getElementById('image-target');
            cropper = new Cropper(img, {
                aspectRatio: DIMS[state.size],
                viewMode: 1, // Restrict to box
                autoCropArea: 1,
                dragMode: 'move',
                background: false
            });
        }

        // 2. TOOLS
        window.rotate = (deg) => { if(cropper) cropper.rotate(deg); };
        
        window.fit = (mode) => {
            if(!cropper) return;
            // Simple logic for v18 stability: Reset zoom
            cropper.reset(); 
        };

        window.setSize = (sz) => {
            state.size = sz;
            document.querySelectorAll('[id^="sz-"]').forEach(b => b.classList.remove('active'));
            document.getElementById('sz-'+sz).classList.add('active');
            if(cropper) cropper.setAspectRatio(DIMS[sz]);
            updatePrice();
        };

        window.setFinish = (f) => {
            state.finish = f;
            document.querySelectorAll('[id^="fn-"]').forEach(b => b.classList.remove('active'));
            document.getElementById('fn-'+f).classList.add('active');
            updatePrice();
        };

        window.qty = (n) => {
            state.qty = Math.max(1, state.qty + n);
            document.getElementById('qty-disp').innerText = state.qty;
            updatePrice();
        };

        function updatePrice() {
            let p = PRICES[state.size] + (state.finish === 'none' ? 0 : 0.05);
            document.getElementById('price').innerText = '$' + (p * state.qty).toFixed(2);
        }

        window.submitOrder = () => {
            alert("Order Submitted! Total: " + document.getElementById('price').innerText);
            location.reload();
        };

    </script>
</body>
</html>
